<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title></title>
	<meta name="generator" content="LibreOffice 25.2.3.2 (Linux)"/>
	<meta name="created" content="00:00:00"/>
	<meta name="changed" content="00:00:00"/>
	<style type="text/css">
		@page { size: 8.27in 11.69in; margin: 0.79in }
		p { margin-bottom: 0.1in; line-height: 115%; background: transparent }
		pre { font-size: 10pt; font-family: "Liberation Mono", monospace; background: transparent }
	</style>
</head>
<body lang="en-US" link="#000080" vlink="#800000" dir="ltr"><pre>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;vi&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
  &lt;title&gt;Cosmic Quiz - Galactic Adventure 6.2&lt;/title&gt;
  &lt;!-- Google Fonts: Exo 2 --&gt;
  &lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.googleapis.com&quot;&gt;
  &lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.gstatic.com&quot; crossorigin&gt;
  &lt;link href=&quot;https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700&amp;display=swap&quot; rel=&quot;stylesheet&quot;&gt;
  &lt;!-- CodeMirror Library --&gt;
  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css&quot;&gt;
  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css&quot;&gt;
  &lt;!-- Font Awesome for Icons --&gt;
  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css&quot;&gt;
  &lt;!-- Defer non-critical scripts --&gt;
  &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js&quot; defer&gt;&lt;/script&gt;
  &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js&quot; defer&gt;&lt;/script&gt;
  &lt;script src=&quot;https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js&quot; defer&gt;&lt;/script&gt;
  &lt;style&gt;
      /* --- PERFORMANCE-OPTIMIZED COSMIC THEME (SUPERNOVA) --- */
      :root {
          --primary-glow: #00aaff;
          --secondary-glow: #ff00ff;
          --success-glow: #00ffaa;
          --danger-glow: #ff4d4d;
          --warning-glow: #ffee00;
          --text-light: #e0e0e0;
          --text-dark: #ffffff;
          --bg-deep-space: #000010;
          --bg-nebula-start: #1a0033;
          --bg-nebula-end: #001a33;
          --glass-bg: rgba(10, 10, 30, 0.75);
          --glass-border: rgba(255, 255, 255, 0.2);
          --shadow-color: rgba(0, 170, 255, 0.3);
      }
      * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Exo 2', sans-serif; }
      html { scroll-behavior: smooth; }
      body {
          background-color: var(--bg-deep-space);
          background-image:
              radial-gradient(circle at 20% 20%, var(--bg-nebula-start) 0%, transparent 40%),
              radial-gradient(circle at 80% 70%, var(--bg-nebula-end) 0%, transparent 40%);
          min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: center;
          color: var(--text-light); position: relative; overflow: hidden;
      }
      #stars-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
      .container {
          width: 100%; max-width: 900px; background: var(--glass-bg); border-radius: 20px;
          box-shadow: 0 0 30px var(--shadow-color); border: 1px solid var(--glass-border);
          backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
          z-index: 1; overflow: hidden; animation: float 6s ease-in-out infinite;
          display: flex; flex-direction: column; max-height: 95vh;
      }
      @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
      .header { padding: 20px 25px; text-align: center; border-bottom: 1px solid var(--glass-border); flex-shrink: 0; }
      .header h1 { font-size: 2.2em; font-weight: 700; background: linear-gradient(45deg, var(--primary-glow), var(--secondary-glow)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 10px rgba(255, 0, 255, 0.3); }
      .header p { color: var(--text-light); font-size: 1em; opacity: 0.8; margin-top: 5px; }
      .user-profile-header {
          margin-top: 15px;
          background: rgba(0,0,0,0.2);
          padding: 8px;
          border-radius: 10px;
          font-size: 0.9em;
      }
      .user-profile-header .rank { font-weight: 600; color: var(--warning-glow); }
      .xp-bar { width: 100%; height: 8px; background-color: rgba(0,0,0,0.3); border-radius: 5px; overflow: hidden; border: 1px solid var(--glass-border); margin-top: 5px; }
      .xp-bar-inner { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary-glow), var(--success-glow)); transition: width 0.5s ease; }

      .tabs { display: flex; background: rgba(0,0,0,0.2); flex-shrink: 0; }
      .tab { flex: 1; padding: 15px 10px; background: transparent; border: none; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease; border-bottom: 3px solid transparent; color: var(--text-light); }
      .tab.active { background: var(--glass-bg); border-bottom-color: var(--primary-glow); color: var(--primary-glow); text-shadow: 0 0 5px var(--primary-glow); }
      .tab:hover:not(.active) { background: rgba(255,255,255,0.1); }
      .tab-content { display: none; padding: 25px; animation: fadeIn 0.4s ease-in-out; overflow-y: auto; flex-grow: 1; }
      .tab-content.active { display: flex; flex-direction: column; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .tab-content::-webkit-scrollbar { width: 8px; }
      .tab-content::-webkit-scrollbar-track { background: transparent; }
      .tab-content::-webkit-scrollbar-thumb { background-color: var(--primary-glow); border-radius: 10px; }
      
      label { display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-dark); }
      input[type=&quot;text&quot;], input[type=&quot;number&quot;], input[type=&quot;search&quot;], textarea, select { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-light); font-size: 1em; }
      textarea { resize: vertical; }
      .CodeMirror { border: 1px solid var(--glass-border); border-radius: 8px; height: auto; font-size: 14px; background: rgba(0,0,0,0.3); flex-grow: 1; }
      #editor-wrapper { display: flex; flex-direction: column; flex-grow: 1; position: relative; }
      #drag-drop-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 170, 255, 0.2); border: 3px dashed var(--primary-glow); border-radius: 8px; display: none; justify-content: center; align-items: center; font-size: 1.5em; font-weight: bold; color: var(--primary-glow); pointer-events: none; }
      .button-group { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 20px; justify-content: center; }
      .button { background: transparent; color: var(--text-light); padding: 12px 25px; border: 2px solid var(--primary-glow); border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.2s ease; text-shadow: 0 0 5px var(--primary-glow); box-shadow: 0 0 10px var(--primary-glow) inset, 0 0 5px var(--primary-glow); display: inline-flex; align-items: center; gap: 8px; }
      .button:hover { background: var(--primary-glow); color: var(--bg-deep-space); text-shadow: none; box-shadow: 0 0 20px var(--primary-glow); transform: translateY(-2px); }
      .button:active { transform: translateY(0); }
      .button.secondary { border-color: var(--secondary-glow); text-shadow: 0 0 5px var(--secondary-glow); box-shadow: 0 0 10px var(--secondary-glow) inset, 0 0 5px var(--secondary-glow); }
      .button.secondary:hover { background: var(--secondary-glow); box-shadow: 0 0 20px var(--secondary-glow); }
      .button.danger { border-color: var(--danger-glow); text-shadow: 0 0 5px var(--danger-glow); box-shadow: 0 0 10px var(--danger-glow) inset, 0 0 5px var(--danger-glow); }
      .button.danger:hover { background: var(--danger-glow); box-shadow: 0 0 20px var(--danger-glow); }
      .button.warning { border-color: var(--warning-glow); text-shadow: 0 0 5px var(--warning-glow); box-shadow: 0 0 10px var(--warning-glow) inset, 0 0 5px var(--warning-glow); }
      .button.warning:hover { background: var(--warning-glow); box-shadow: 0 0 20px var(--warning-glow); color: var(--bg-deep-space); }
      .button:disabled { cursor: not-allowed; opacity: 0.5; transform: none; box-shadow: none; }
      .status-message { padding: 10px; border-radius: 5px; margin-top: 15px; text-align: center; opacity: 1; transition: opacity 0.3s; }
      .status-message.success { background-color: rgba(0, 255, 170, 0.2); border: 1px solid var(--success-glow); color: var(--success-glow); }
      .status-message.error { background-color: rgba(255, 77, 77, 0.2); border: 1px solid var(--danger-glow); color: var(--danger-glow); }
      .status-message.info { background-color: rgba(0, 170, 255, 0.2); border: 1px solid var(--primary-glow); color: var(--primary-glow); }
      .loader { width: 48px; height: 48px; border: 4px solid var(--primary-glow); border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
      @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      #quiz.tab-content.active { padding: 0; }
      .quiz-header { text-align: center; padding: 20px; flex-shrink: 0; border-bottom: 1px solid var(--glass-border); background: rgba(10, 10, 30, 0.85); }
      #questions-list-container { overflow-y: auto; flex-grow: 1; padding: 20px; }
      .quiz-button-container { padding: 20px; border-top: 1px solid var(--glass-border); flex-shrink: 0; }
      .progress-bar { width: 100%; height: 10px; background-color: rgba(0,0,0,0.3); border-radius: 5px; overflow: hidden; border: 1px solid var(--glass-border); margin-top: 10px; }
      .progress-bar-inner { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary-glow), var(--secondary-glow)); transition: width 0.4s ease; }
      .question-card { background: var(--glass-bg); border-radius: 12px; padding: 25px; margin-bottom: 20px; border: 1px solid var(--glass-border); animation: fadeInUp 0.5s ease-out forwards; opacity: 0; transition: opacity 0.3s; }
      .question-card.answered { opacity: 0.7; pointer-events: none; }
      .question-card.answered .options { pointer-events: none; }
      /* FIX: Re-enable pointer events for the navigation/submit button inside an answered card */
      .question-card.answered .sq-card-nav {
          pointer-events: auto;
      }
      @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
      .question-image { max-width: 100%; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--glass-border); }
      .option label { display: flex; align-items: center; padding: 15px; background: rgba(0,0,0,0.2); border: 2px solid var(--glass-border); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; margin-bottom: 10px; }
      .option label:hover { border-color: var(--primary-glow); background: var(--glass-bg); }
      .option input { display: none; }
      .option input:checked + label { border-color: var(--primary-glow); background: var(--glass-bg); font-weight: 600; color: var(--primary-glow); }
      .option label.instant-correct { border-color: var(--success-glow) !important; background: rgba(0, 255, 170, 0.2) !important; color: var(--success-glow) !important; }
      .option label.instant-incorrect { border-color: var(--danger-glow) !important; background: rgba(255, 77, 77, 0.2) !important; color: var(--danger-glow) !important; }
      .instant-explanation { display: none; background: rgba(255, 238, 0, 0.1); border: 1px solid var(--warning-glow); color: var(--warning-glow); padding: 10px; border-radius: 5px; margin-top: 10px; }
      #single-question-view { display: flex; flex-direction: column; height: 100%; }
      #sq-question-container { flex-grow: 1; overflow-y: auto; padding: 20px; }
      #sq-navigation { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-top: 1px solid var(--glass-border); flex-shrink: 0; }
      #sq-nav-dots { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
      .nav-dot { width: 25px; height: 25px; border-radius: 50%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; font-size: 0.8em; }
      .nav-dot:hover { background: var(--glass-bg); border-color: var(--primary-glow); }
      .nav-dot.current { background: var(--primary-glow); color: var(--bg-deep-space); border-color: var(--primary-glow); font-weight: bold; }
      .nav-dot.answered { background: rgba(0, 255, 170, 0.2); border-color: var(--success-glow); }
      .sq-card-nav { margin-top: 25px; text-align: center; }
      .creator-section { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--glass-border); }
      .creator-section h3 { margin-bottom: 15px; color: var(--primary-glow); border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; }
      .creator-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
      .creator-question { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--glass-border); }
      .creator-option { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
      .creator-option input[type=&quot;text&quot;] { flex-grow: 1; }
      .creator-option input[type=&quot;radio&quot;], .creator-option input[type=&quot;checkbox&quot;] { flex-shrink: 0; width: 20px; height: 20px; cursor: pointer; }
      .creator-option .button.danger { padding: 5px 10px; font-size: 0.8em; }
      .form-group { margin-bottom: 20px; }
      .form-group.inline { display: flex; align-items: center; gap: 15px; }
      .form-group.inline label { margin-bottom: 0; }
      .form-group.inline input[type=&quot;checkbox&quot;] { width: 20px; height: 20px; }
      .form-group.inline label[disabled] { opacity: 0.5; cursor: not-allowed; }
      .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary-glow); }
      .history-info h4 { margin: 0; color: var(--text-dark); }
      .history-info p { margin: 5px 0 0; font-size: 0.9em; opacity: 0.7; }
      .history-score { font-size: 1.2em; font-weight: 600; color: var(--primary-glow); }
      .review-filters { margin-bottom: 20px; }
      .review-filters .button { border-width: 1px; box-shadow: none; }
      .review-filters .button.active { background: var(--primary-glow); color: var(--bg-deep-space); text-shadow: none; }
      .review-question.hidden { display: none; }
      .modal-overlay, #pause-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
      .modal-content { background: var(--glass-bg); padding: 30px; border-radius: 15px; border: 1px solid var(--glass-border); box-shadow: 0 0 25px rgba(0,0,0,0.5); width: 90%; max-width: 600px; text-align: center; animation: float 0.3s ease-out; }
      .modal-content h2 { margin-bottom: 15px; color: var(--primary-glow); }
      .modal-content p { margin-bottom: 25px; }
      #pause-overlay h2 { font-size: 3em; color: var(--warning-glow); text-shadow: 0 0 15px var(--warning-glow); }
      #quiz-library-list { max-height: 300px; overflow-y: auto; margin-top: 20px; text-align: left; }
      .quiz-library-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 6px; margin-bottom: 8px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); }
      .quiz-library-item:hover { background: rgba(0,0,0,0.4); }
      .achievement-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; margin-top: 20px; }
      .achievement-card { background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 12px; padding: 20px; text-align: center; transition: all 0.3s ease; }
      .achievement-card.unlocked { border-color: var(--warning-glow); box-shadow: 0 0 10px var(--warning-glow); }
      .achievement-card.locked { opacity: 0.4; filter: grayscale(80%); }
      .achievement-card i { font-size: 2.5em; margin-bottom: 10px; color: var(--warning-glow); }
      .achievement-card h4 { font-size: 1em; margin-bottom: 5px; color: var(--text-dark); }
      .achievement-card p { font-size: 0.8em; opacity: 0.7; }
      .notifier { position: fixed; top: 20%; left: 50%; transform: translateX(-50%) translateY(20px); z-index: 9999; pointer-events: none; opacity: 0; transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1); }
      .notifier.show { opacity: 1; transform: translateX(-50%) translateY(0); }
      .streak-notifier-content { font-size: 2.5em; font-weight: 700; color: var(--warning-glow); text-shadow: 0 0 15px var(--warning-glow), 0 0 25px var(--warning-glow); animation: pulse 1s infinite; }
      @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
      .achievement-notifier-content { background: var(--glass-bg); border: 1px solid var(--warning-glow); border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 15px; box-shadow: 0 0 20px var(--warning-glow); }
      .achievement-notifier-content i { font-size: 2em; color: var(--warning-glow); }
      /* Styles for Matching Question Type */
      .matching-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; }
      .matching-item { display: contents; }
      .matching-item p { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; text-align: center; }
      .matching-item select { margin: 0; }
      .creator-matching-pair { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center; }

      @media (max-width: 768px) {
          body { padding: 5px; align-items: flex-start; }
          .container { animation: none; max-height: 98vh; border-radius: 10px; }
          .header h1 { font-size: 1.8em; }
          .tab { font-size: 0.8em; padding: 12px 5px; }
          .tab-content { padding: 15px; }
          #quiz.tab-content.active { padding: 0; }
          .button { padding: 10px 15px; font-size: 0.9em; }
          .creator-grid { grid-template-columns: 1fr; }
          .history-item { flex-direction: column; align-items: flex-start; gap: 10px; }
          #sq-navigation { flex-direction: column; gap: 15px; }
          .matching-grid { grid-template-columns: 1fr; }
          .matching-item p { text-align: left; }
      }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;canvas id=&quot;stars-canvas&quot;&gt;&lt;/canvas&gt;
  &lt;div class=&quot;container&quot;&gt;
      &lt;header class=&quot;header&quot;&gt;
          &lt;h1&gt;‚òÑÔ∏è Cosmic Quiz - Galactic Adventure&lt;/h1&gt;
          &lt;p&gt;Chinh ph·ª•c v≈© tr·ª• tri th·ª©c v√† thƒÉng h·∫°ng trong thi√™n h√†.&lt;/p&gt;
          &lt;div class=&quot;user-profile-header&quot;&gt;
              &lt;div&gt;H·∫°ng: &lt;span id=&quot;userRank&quot; class=&quot;rank&quot;&gt;&lt;/span&gt; | XP: &lt;span id=&quot;userXP&quot;&gt;&lt;/span&gt;&lt;/div&gt;
              &lt;div class=&quot;xp-bar&quot;&gt;
                  &lt;div id=&quot;xpBarInner&quot; class=&quot;xp-bar-inner&quot;&gt;&lt;/div&gt;
              &lt;/div&gt;
          &lt;/div&gt;
      &lt;/header&gt;
      &lt;div class=&quot;tabs&quot;&gt;
          &lt;button class=&quot;tab active&quot; onclick=&quot;showTab('creator')&quot;&gt;&lt;i class=&quot;fa-solid fa-hammer&quot;&gt;&lt;/i&gt; X∆∞·ªüng&lt;/button&gt;
          &lt;button class=&quot;tab&quot; onclick=&quot;showTab('editor')&quot;&gt;&lt;i class=&quot;fa-solid fa-satellite-dish&quot;&gt;&lt;/i&gt; So·∫°n Th·∫£o&lt;/button&gt;
          &lt;button class=&quot;tab&quot; onclick=&quot;showTab('quiz')&quot;&gt;&lt;i class=&quot;fa-solid fa-rocket&quot;&gt;&lt;/i&gt; B·ªá Ph√≥ng&lt;/button&gt;
          &lt;button class=&quot;tab&quot; onclick=&quot;showTab('history')&quot;&gt;&lt;i class=&quot;fa-solid fa-book-journal-whills&quot;&gt;&lt;/i&gt; L·ªãch S·ª≠&lt;/button&gt;
          &lt;button class=&quot;tab&quot; onclick=&quot;showTab('profile')&quot;&gt;&lt;i class=&quot;fa-solid fa-user-astronaut&quot;&gt;&lt;/i&gt; H·ªì S∆°&lt;/button&gt;
      &lt;/div&gt;
      
      &lt;div id=&quot;creator&quot; class=&quot;tab-content active&quot;&gt;
           &lt;div id=&quot;creatorForm&quot;&gt;
               &lt;div class=&quot;creator-section&quot;&gt;
                    &lt;h3&gt;&lt;i class=&quot;fa-solid fa-database&quot;&gt;&lt;/i&gt; Th∆∞ Vi·ªán ƒê·ªÅ Thi&lt;/h3&gt;
                    &lt;p style=&quot;text-align: center; opacity: 0.8; margin-bottom: 20px;&quot;&gt;L∆∞u v√† qu·∫£n l√Ω c√°c b·ªô ƒë·ªÅ thi c·ªßa b·∫°n.&lt;/p&gt;
                    &lt;div class=&quot;button-group&quot;&gt;
                        &lt;button class=&quot;button&quot; onclick=&quot;saveQuizToLibrary()&quot;&gt;&lt;i class=&quot;fa-solid fa-save&quot;&gt;&lt;/i&gt; L∆∞u ƒê·ªÅ Hi·ªán T·∫°i&lt;/button&gt;
                        &lt;button class=&quot;button secondary&quot; onclick=&quot;showQuizLibrary()&quot;&gt;&lt;i class=&quot;fa-solid fa-box-archive&quot;&gt;&lt;/i&gt; M·ªü Th∆∞ Vi·ªán&lt;/button&gt;
                    &lt;/div&gt;
               &lt;/div&gt;
               &lt;div class=&quot;creator-section&quot;&gt;
                    &lt;h3&gt;&lt;i class=&quot;fa-solid fa-wand-magic-sparkles&quot;&gt;&lt;/i&gt; T·∫°o ƒê·ªÅ B·∫±ng AI üöÄ&lt;/h3&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;aiTopic&quot;&gt;Nh·∫≠p ch·ªß ƒë·ªÅ chung&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;aiTopic&quot; placeholder=&quot;V√≠ d·ª•: L·ªãch s·ª≠ Vi·ªát Nam, English literature, <span lang="zh-CN">Êó•Êú¨„ÅÆÊñáÂåñ</span>...&quot;&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;creator-grid&quot;&gt;
                        &lt;div class=&quot;form-group&quot;&gt;
                            &lt;label for=&quot;aiNumQuestions&quot;&gt;S·ªë l∆∞·ª£ng c√¢u h·ªèi&lt;/label&gt;
                            &lt;input type=&quot;number&quot; id=&quot;aiNumQuestions&quot; value=&quot;5&quot; min=&quot;1&quot; max=&quot;20&quot;&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;button-group&quot;&gt;
                        &lt;button class=&quot;button warning&quot; id=&quot;aiGenerateBtn&quot; onclick=&quot;generateQuizWithAI()&quot;&gt;
                            &lt;i class=&quot;fa-solid fa-brain&quot;&gt;&lt;/i&gt; T·∫°o C√¢u H·ªèi
                        &lt;/button&gt;
                    &lt;/div&gt;
                    &lt;div id=&quot;aiStatus&quot; style=&quot;text-align: center; margin-top: 15px;&quot; aria-live=&quot;polite&quot;&gt;&lt;/div&gt;
                    &lt;div id=&quot;aiActionsContainer&quot; class=&quot;button-group&quot; style=&quot;display: none; animation: fadeIn 0.5s;&quot;&gt;
                        &lt;hr style=&quot;width: 100%; border-color: var(--glass-border); margin: 10px 0;&quot;&gt;
                        &lt;p style=&quot;width: 100%; text-align: center; opacity: 0.8;&quot;&gt;AI ƒë√£ t·∫°o xong. B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu ngay!&lt;/p&gt;
                        &lt;button class=&quot;button&quot; onclick=&quot;startQuizFromCreator()&quot;&gt;&lt;i class=&quot;fa-solid fa-play&quot;&gt;&lt;/i&gt; B·∫Øt ƒê·∫ßu Ngay&lt;/button&gt;
                        &lt;button class=&quot;button secondary&quot; onclick=&quot;generateJsonAndSwitch()&quot;&gt;&lt;i class=&quot;fa-solid fa-code&quot;&gt;&lt;/i&gt; Xem &amp; Ch·ªânh s·ª≠a JSON&lt;/button&gt;
                    &lt;/div&gt;
               &lt;/div&gt;
               &lt;div class=&quot;creator-section&quot;&gt;
                    &lt;h3&gt;&lt;i class=&quot;fa-solid fa-sliders&quot;&gt;&lt;/i&gt; C√†i ƒê·∫∑t T·ªïng Quan&lt;/h3&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;creatorTitle&quot;&gt;Ti√™u ƒë·ªÅ b√†i thi&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;creatorTitle&quot; placeholder=&quot;H√†nh Tr√¨nh Kh√°m Ph√° V≈© Tr·ª•&quot; oninput=&quot;updateCreatorConfig('title', this.value)&quot;&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;creator-grid&quot;&gt;
                        &lt;div class=&quot;form-group&quot;&gt;
                            &lt;label for=&quot;creatorTimeLimit&quot;&gt;Th·ªùi gian (gi√¢y, 0 = kh√¥ng gi·ªõi h·∫°n)&lt;/label&gt;
                            &lt;input type=&quot;number&quot; id=&quot;creatorTimeLimit&quot; value=&quot;600&quot; min=&quot;0&quot; oninput=&quot;updateCreatorConfig('timeLimit', this.value)&quot;&gt;
                        &lt;/div&gt;
                        &lt;div class=&quot;form-group&quot;&gt;
                             &lt;label&gt;T√πy ch·ªçn kh√°c&lt;/label&gt;
                             &lt;div class=&quot;form-group inline&quot;&gt;
                                &lt;input type=&quot;checkbox&quot; id=&quot;creatorShuffleQuestions&quot; checked onchange=&quot;updateCreatorConfig('shuffleQuestions', this.checked)&quot;&gt;
                                &lt;label for=&quot;creatorShuffleQuestions&quot;&gt;X√°o tr·ªôn c√¢u h·ªèi&lt;/label&gt;
                             &lt;/div&gt;
                             &lt;div class=&quot;form-group inline&quot;&gt;
                                &lt;input type=&quot;checkbox&quot; id=&quot;creatorShuffleOptions&quot; checked onchange=&quot;updateCreatorConfig('shuffleOptions', this.checked)&quot;&gt;
                                &lt;label for=&quot;creatorShuffleOptions&quot;&gt;X√°o tr·ªôn ƒë√°p √°n&lt;/label&gt;
                             &lt;/div&gt;
                             &lt;div class=&quot;form-group inline&quot;&gt;
                                &lt;input type=&quot;checkbox&quot; id=&quot;creatorInstantFeedback&quot; onchange=&quot;updateCreatorConfig('instantFeedback', this.checked)&quot;&gt;
                                &lt;label for=&quot;creatorInstantFeedback&quot;&gt;Ph·∫£n h·ªìi t·ª©c th√¨&lt;/label&gt;
                             &lt;/div&gt;
                             &lt;div class=&quot;form-group inline&quot;&gt;
                                &lt;input type=&quot;checkbox&quot; id=&quot;creatorSingleQuestionMode&quot; onchange=&quot;handleSingleModeToggle(this.checked)&quot;&gt;
                                &lt;label for=&quot;creatorSingleQuestionMode&quot;&gt;Ch·∫ø ƒë·ªô t·ª´ng c√¢u&lt;/label&gt;
                             &lt;/div&gt;
                             &lt;div class=&quot;form-group inline&quot;&gt;
                                &lt;input type=&quot;checkbox&quot; id=&quot;creatorAutoNextQuestion&quot; onchange=&quot;updateCreatorConfig('autoNextQuestion', this.checked)&quot; disabled&gt;
                                &lt;label for=&quot;creatorAutoNextQuestion&quot; id=&quot;creatorAutoNextQuestionLabel&quot; disabled&gt;T·ª± ƒë·ªông chuy·ªÉn c√¢u&lt;/label&gt;
                             &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
               &lt;/div&gt;
               &lt;div class=&quot;creator-section&quot;&gt;
                    &lt;h3&gt;&lt;i class=&quot;fa-solid fa-list-ul&quot;&gt;&lt;/i&gt; Danh S√°ch C√¢u H·ªèi (Ch·ªânh s·ª≠a th·ªß c√¥ng)&lt;/h3&gt;
                    &lt;div id=&quot;questionsList&quot;&gt;
                        &lt;p style=&quot;text-align: center; opacity: 0.7;&quot;&gt;Ch∆∞a c√≥ c√¢u h·ªèi n√†o. H√£y d√πng AI ho·∫∑c th√™m th·ªß c√¥ng!&lt;/p&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;button-group&quot;&gt;
                        &lt;button class=&quot;button&quot; onclick=&quot;creatorAddQuestion()&quot;&gt;&lt;i class=&quot;fa-solid fa-plus&quot;&gt;&lt;/i&gt; Th√™m C√¢u H·ªèi&lt;/button&gt;
                    &lt;/div&gt;
               &lt;/div&gt;
           &lt;/div&gt;
      &lt;/div&gt;
      &lt;div id=&quot;editor&quot; class=&quot;tab-content&quot;&gt;
          &lt;div id=&quot;editor-wrapper&quot;&gt;
               &lt;div id=&quot;drag-drop-overlay&quot;&gt;&lt;i class=&quot;fa-solid fa-file-import&quot;&gt;&lt;/i&gt; Th·∫£ file JSON v√†o ƒë√¢y&lt;/div&gt;
               &lt;label for=&quot;jsonInput&quot;&gt;üë®‚ÄçüöÄ Nh·∫≠p ho·∫∑c ch·ªânh s·ª≠a d·ªØ li·ªáu JSON:&lt;/label&gt;
               &lt;textarea id=&quot;jsonInput&quot;&gt;&lt;/textarea&gt;
               &lt;div class=&quot;button-group&quot;&gt;
                   &lt;button class=&quot;button&quot; onclick=&quot;loadQuestionsFromJson()&quot;&gt;&lt;i class=&quot;fa-solid fa-play&quot;&gt;&lt;/i&gt; B·∫Øt ƒê·∫ßu&lt;/button&gt;
                   &lt;button class=&quot;button&quot; onclick=&quot;loadSampleQuestions()&quot;&gt;&lt;i class=&quot;fa-solid fa-wand-magic-sparkles&quot;&gt;&lt;/i&gt; T·∫£i M·∫´u&lt;/button&gt;
                   &lt;button class=&quot;button secondary&quot; onclick=&quot;copyJson()&quot;&gt;&lt;i class=&quot;fa-solid fa-copy&quot;&gt;&lt;/i&gt; Sao Ch√©p&lt;/button&gt;
                   &lt;button class=&quot;button danger&quot; onclick=&quot;confirmClearEditor()&quot;&gt;&lt;i class=&quot;fa-solid fa-trash&quot;&gt;&lt;/i&gt; X√≥a&lt;/button&gt;
               &lt;/div&gt;
               &lt;div class=&quot;button-group&quot;&gt;
                   &lt;button class=&quot;button&quot; onclick=&quot;document.getElementById('fileInput').click()&quot;&gt;&lt;i class=&quot;fa-solid fa-upload&quot;&gt;&lt;/i&gt; Import JSON&lt;/button&gt;
                   &lt;input type=&quot;file&quot; id=&quot;fileInput&quot; accept=&quot;.json&quot; style=&quot;display: none;&quot; onchange=&quot;importJsonFromFile(event)&quot;&gt;
                   &lt;button class=&quot;button secondary&quot; onclick=&quot;exportJsonToFile()&quot;&gt;&lt;i class=&quot;fa-solid fa-download&quot;&gt;&lt;/i&gt; Export JSON&lt;/button&gt;
               &lt;/div&gt;
               &lt;div id=&quot;editorStatus&quot; aria-live=&quot;polite&quot;&gt;&lt;/div&gt;
           &lt;/div&gt;
      &lt;/div&gt;
      &lt;div id=&quot;quiz&quot; class=&quot;tab-content&quot;&gt;
          &lt;div id=&quot;quizContent&quot; style=&quot;height: 100%;&quot;&gt;
               &lt;div style=&quot;text-align: center; padding: 50px; color: var(--text-light);&quot;&gt;
                   &lt;h2&gt;üåå Ch∆∞a c√≥ d·ªØ li·ªáu h√†nh tr√¨nh&lt;/h2&gt;
                   &lt;p&gt;Vui l√≤ng t·∫°o ho·∫∑c t·∫£i ƒë·ªÅ thi v√† nh·∫•n &quot;B·∫Øt ƒê·∫ßu&quot;.&lt;/p&gt;
               &lt;/div&gt;
           &lt;/div&gt;
      &lt;/div&gt;
      &lt;div id=&quot;history&quot; class=&quot;tab-content&quot;&gt;
          &lt;div style=&quot;display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;&quot;&gt;
               &lt;h2 style=&quot;color: var(--primary-glow);&quot;&gt;L·ªãch S·ª≠ L√†m B√†i&lt;/h2&gt;
               &lt;button class=&quot;button danger&quot; id=&quot;clearHistoryBtn&quot;&gt;&lt;i class=&quot;fa-solid fa-trash&quot;&gt;&lt;/i&gt; X√≥a L·ªãch S·ª≠&lt;/button&gt;
           &lt;/div&gt;
           &lt;div class=&quot;form-group&quot;&gt;
               &lt;input type=&quot;search&quot; id=&quot;historySearch&quot; placeholder=&quot;üîç T√¨m ki·∫øm theo ti√™u ƒë·ªÅ...&quot;&gt;
           &lt;/div&gt;
           &lt;div id=&quot;historyList&quot;&gt;&lt;/div&gt;
      &lt;/div&gt;
      &lt;div id=&quot;profile&quot; class=&quot;tab-content&quot;&gt;
          &lt;h2 style=&quot;color: var(--primary-glow); text-align: center;&quot;&gt;B·ªô S∆∞u T·∫≠p Th√†nh T√≠ch&lt;/h2&gt;
          &lt;p style=&quot;text-align: center; opacity: 0.8; margin-bottom: 20px;&quot;&gt;ƒê√¢y l√† nh·ªØng c·ªôt m·ªëc vinh quang trong h√†nh tr√¨nh c·ªßa b·∫°n.&lt;/p&gt;
          &lt;div id=&quot;achievementGrid&quot; class=&quot;achievement-grid&quot;&gt;&lt;/div&gt;
      &lt;/div&gt;
  &lt;/div&gt;

  &lt;!-- MODALS &amp; OVERLAYS --&gt;
  &lt;div id=&quot;modal&quot; class=&quot;modal-overlay&quot; role=&quot;dialog&quot; aria-modal=&quot;true&quot; aria-labelledby=&quot;modalTitle&quot;&gt;
      &lt;div class=&quot;modal-content&quot;&gt;
           &lt;h2 id=&quot;modalTitle&quot;&gt;X√°c nh·∫≠n&lt;/h2&gt;
           &lt;p id=&quot;modalText&quot;&gt;B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?&lt;/p&gt;
           &lt;div class=&quot;button-group&quot;&gt;
               &lt;button id=&quot;modalConfirm&quot; class=&quot;button&quot;&gt;X√°c nh·∫≠n&lt;/button&gt;
               &lt;button id=&quot;modalCancel&quot; class=&quot;button danger&quot;&gt;H·ªßy&lt;/button&gt;
           &lt;/div&gt;
       &lt;/div&gt;
  &lt;/div&gt;
  &lt;div id=&quot;quizLibraryModal&quot; class=&quot;modal-overlay&quot; role=&quot;dialog&quot; aria-modal=&quot;true&quot; aria-labelledby=&quot;quizLibraryTitle&quot;&gt;
      &lt;div class=&quot;modal-content&quot;&gt;
           &lt;h2 id=&quot;quizLibraryTitle&quot;&gt;&lt;i class=&quot;fa-solid fa-box-archive&quot;&gt;&lt;/i&gt; Th∆∞ Vi·ªán ƒê·ªÅ Thi&lt;/h2&gt;
           &lt;div id=&quot;quiz-library-list&quot;&gt;&lt;/div&gt;
           &lt;div class=&quot;button-group&quot;&gt;
               &lt;button class=&quot;button danger&quot; onclick=&quot;hideModal('quizLibraryModal')&quot;&gt;ƒê√≥ng&lt;/button&gt;
           &lt;/div&gt;
       &lt;/div&gt;
  &lt;/div&gt;
  &lt;div id=&quot;pause-overlay&quot; class=&quot;modal-overlay&quot;&gt;
      &lt;div class=&quot;modal-content&quot;&gt;
           &lt;h2 id=&quot;pauseTitle&quot;&gt;‚è∏Ô∏è ƒê√É T·∫†M D·ª™NG&lt;/h2&gt;
           &lt;p&gt;Th·ªùi gian c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c d·ª´ng l·∫°i. Nh·∫•n ƒë·ªÉ ti·∫øp t·ª•c.&lt;/p&gt;
           &lt;button class=&quot;button warning&quot; onclick=&quot;resumeQuiz()&quot;&gt;Ti·∫øp T·ª•c &lt;i class=&quot;fa-solid fa-play&quot;&gt;&lt;/i&gt;&lt;/button&gt;
       &lt;/div&gt;
  &lt;/div&gt;

  &lt;div id=&quot;streakNotifier&quot; class=&quot;notifier&quot;&gt;
      &lt;div class=&quot;streak-notifier-content&quot;&gt;&lt;/div&gt;
  &lt;/div&gt;
  &lt;div id=&quot;achievementNotifier&quot; class=&quot;notifier&quot;&gt;
      &lt;div class=&quot;achievement-notifier-content&quot;&gt;&lt;/div&gt;
  &lt;/div&gt;

&lt;script&gt;
// --- GAME CONFIG &amp; CONSTANTS ---
const RANKS = [
  { name: &quot;T√¢n Binh V≈© Tr·ª•&quot;, xp: 0, icon: &quot;fa-baby-carriage&quot; },
  { name: &quot;Phi H√†nh Gia T·∫≠p S·ª±&quot;, xp: 1000, icon: &quot;fa-user-graduate&quot; },
  { name: &quot;Hoa Ti√™u Tinh H·ªá&quot;, xp: 2500, icon: &quot;fa-map-location-dot&quot; },
  { name: &quot;Thuy·ªÅn Tr∆∞·ªüng Du H√†nh&quot;, xp: 5000, icon: &quot;fa-satellite&quot; },
  { name: &quot;ƒê√¥ ƒê·ªëc Thi√™n H√†&quot;, xp: 10000, icon: &quot;fa-star&quot; },
  { name: &quot;K·∫ª Chinh Ph·ª•c V≈© Tr·ª•&quot;, xp: 20000, icon: &quot;fa-crown&quot; }
];

const ALL_ACHIEVEMENTS = {
  'FIRST_FLIGHT': { title: &quot;Chuy·∫øn Bay ƒê·∫ßu Ti√™n&quot;, desc: &quot;Ho√†n th√†nh b√†i thi ƒë·∫ßu ti√™n.&quot;, icon: &quot;fa-rocket&quot; },
  'PERFECTIONIST': { title: &quot;Nh√† V√¥ ƒê·ªãch&quot;, desc: &quot;ƒê·∫°t 100% ƒëi·ªÉm trong m·ªôt b√†i thi.&quot;, icon: &quot;fa-trophy&quot; },
  'LIGHT_SPEED': { title: &quot;T·ªëc ƒê·ªô √Ånh S√°ng&quot;, desc: &quot;Ho√†n th√†nh b√†i thi khi c√≤n h∆°n 50% th·ªùi gian.&quot;, icon: &quot;fa-bolt&quot; },
  'CREATOR': { title: &quot;Nh√† S√°ng T·∫°o&quot;, desc: &quot;T·ª± t·∫°o v√† l∆∞u m·ªôt b·ªô ƒë·ªÅ thi.&quot;, icon: &quot;fa-hammer&quot; },
  'LIBRARIAN': { title: &quot;Th∆∞ Vi·ªán Tr√≠ Th·ª©c&quot;, desc: &quot;L∆∞u 5 b·ªô ƒë·ªÅ thi v√†o th∆∞ vi·ªán.&quot;, icon: &quot;fa-book-atlas&quot; },
  'STREAK_MASTER': { title: &quot;N√≥ng B·ªèng&quot;, desc: &quot;ƒê·∫°t chu·ªói 10 c√¢u tr·∫£ l·ªùi ƒë√∫ng.&quot;, icon: &quot;fa-fire&quot; },
  'AI_ASSISTED': { title: &quot;Tr·ª£ L√Ω AI&quot;, desc: &quot;T·∫°o m·ªôt b√†i thi b·∫±ng AI.&quot;, icon: &quot;fa-brain&quot; },
  'CONSISTENT': { title: &quot;Chuy√™n C·∫ßn&quot;, desc: &quot;Ho√†n th√†nh 5 b√†i thi.&quot;, icon: &quot;fa-calendar-check&quot; },
};


// --- STATE MANAGEMENT ---
let appState = {
  currentQuizData: null,
  userAnswers: {},
  quizTimer: null,
  timeLeft: 0,
  isPaused: false,
  jsonEditor: null,
  quizStartTime: null,
  quizEndTime: null,
  shuffledQuestions: [],
  shuffledOptions: {},
  quizHistory: [],
  savedQuizzes: [],
  currentQuestionIndex: 0,
  modal: {
      lastFocusedElement: null,
      onConfirm: () =&gt; {},
      onCancel: () =&gt; hideModal('modal'),
  },
  creatorData: {
      id: `quiz_${Date.now()}`,
      title: &quot;B√†i Thi M·ªõi&quot;,
      config: { timeLimit: 600, shuffleQuestions: true, shuffleOptions: true, instantFeedback: false, singleQuestionMode: false, autoNextQuestion: false },
      questions: []
  },
  hasUnsavedChanges: false,
  userProfile: {
      xp: 0,
      achievements: [],
  },
  currentStreak: 0,
  longestStreak: 0,
};

// --- CANVAS STARFIELD BACKGROUND ---
function setupStarfield() {
  const canvas = document.getElementById('stars-canvas');     if (!canvas) return;     const ctx = canvas.getContext('2d');     let stars = [];     let animationFrameId;     function resizeCanvas() {         cancelAnimationFrame(animationFrameId);         canvas.width = window.innerWidth;         canvas.height = window.innerHeight;         stars = [];         for (let i = 0; i &lt; 400; i++) {             stars.push({                 x: Math.random() * canvas.width,                 y: Math.random() * canvas.height,                 radius: Math.random() * 1.5,                 vx: 0,                 vy: (Math.random() * 0.5) + 0.2             });         }         animate();     }     function animate() {         ctx.clearRect(0, 0, canvas.width, canvas.height);         ctx.fillStyle = &quot;#fff&quot;;         stars.forEach(s =&gt; {             s.y += s.vy;             if (s.y &gt; canvas.height) {                 s.y = 0;                 s.x = Math.random() * canvas.width;             }             ctx.beginPath();             ctx.arc(s.x, s.y, s.radius, 0, 2 * Math.PI);             ctx.fill();         });         animationFrameId = requestAnimationFrame(animate);     }     window.addEventListener('resize', resizeCanvas);     resizeCanvas();
}

// --- UTILITY &amp; EFFECTS FUNCTIONS ---
function shuffleArray(array) { const newArray = [...array]; for (let i = newArray.length - 1; i &gt; 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [newArray[i], newArray[j]] = [newArray[j], newArray[i]]; } return newArray; }
function arraysEqual(a, b) { if (!Array.isArray(a) || !Array.isArray(b)) return false; if (a.length !== b.length) return false; const sortedA = [...a].sort((x, y) =&gt; String(x).localeCompare(String(y))); const sortedB = [...b].sort((x, y) =&gt; String(x).localeCompare(String(y))); return sortedA.every((val, index) =&gt; val === sortedB[index]); }
function launchConfetti() { if (window.confetti) { confetti({ particleCount: 150, spread: 180, origin: { y: 0.6 }, zIndex: 2000 }); } }
function animateScore(targetElement, finalScore, totalScore) { let currentScore = 0; const increment = Math.max(1, Math.ceil(finalScore / 100)); const step = () =&gt; { currentScore += increment; if (currentScore &gt;= finalScore) { targetElement.textContent = `${finalScore} / ${totalScore} ƒëi·ªÉm`; return; } targetElement.textContent = `${currentScore} / ${totalScore} ƒëi·ªÉm`; requestAnimationFrame(step); }; requestAnimationFrame(step); }
function formatTime(seconds) { if (isNaN(seconds) || seconds &lt; 0) return &quot;00:00&quot;; const mins = Math.floor(seconds / 60); const secs = seconds % 60; return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`; }

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () =&gt; {
  appState.jsonEditor = CodeMirror.fromTextArea(document.getElementById('jsonInput'), {
      mode: { name: &quot;javascript&quot;, json: true },
      lineNumbers: true,
      theme: &quot;dracula&quot;,
      autofocus: true
  });
  const savedJson = localStorage.getItem('quizJson');
  if (savedJson) {
      try { appState.jsonEditor.setValue(JSON.stringify(JSON.parse(savedJson), null, 4)); } catch (e) { localStorage.removeItem('quizJson'); }
  }
  setupStarfield();
  loadHistory();
  loadSavedQuizzes();
  loadUserProfile();
  showTab('creator');
  renderCreatorUI();
  renderAchievements();
  document.getElementById('clearHistoryBtn').addEventListener('click', () =&gt; {
      showModal('modal', 'X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ l√†m b√†i? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.', clearHistory);
  });
  document.getElementById('historySearch').addEventListener('input', (e) =&gt; renderHistory(e.target.value));
  const editorWrapper = document.getElementById('editor-wrapper');
  const dragDropOverlay = document.getElementById('drag-drop-overlay');
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName =&gt; {
      editorWrapper.addEventListener(eventName, (e) =&gt; { e.preventDefault(); e.stopPropagation(); }, false);
  });
  ['dragenter', 'dragover'].forEach(eventName =&gt; {
      editorWrapper.addEventListener(eventName, () =&gt; { dragDropOverlay.style.display = 'flex'; }, false);
  });
  ['dragleave', 'drop'].forEach(eventName =&gt; {
      editorWrapper.addEventListener(eventName, () =&gt; { dragDropOverlay.style.display = 'none'; }, false);
  });
  editorWrapper.addEventListener('drop', handleFileDrop, false);
  window.addEventListener('beforeunload', (e) =&gt; {
      const inQuiz = document.getElementById('quiz').classList.contains('active') &amp;&amp; appState.currentQuizData;
      if (appState.hasUnsavedChanges || inQuiz) {
          e.preventDefault();
          e.returnValue = '';
          return 'B·∫°n c√≥ thay ƒë·ªïi ch∆∞a l∆∞u ho·∫∑c b√†i thi ƒëang l√†m d·ªü. B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi ƒëi?';
      }
  });
  const modal = document.getElementById('modal');
  modal.addEventListener('keydown', (e) =&gt; handleModalKeydown(e, 'modal'));
  document.getElementById('modalCancel').addEventListener('click', () =&gt; appState.modal.onCancel());
  document.getElementById('modalConfirm').addEventListener('click', () =&gt; appState.modal.onConfirm());
});

// --- UI &amp; THEME ---
function showTab(tabName) { document.querySelectorAll('.tab-content').forEach(c =&gt; c.classList.remove('active')); document.querySelectorAll('.tab').forEach(t =&gt; t.classList.remove('active')); document.getElementById(tabName).classList.add('active'); document.querySelector(`.tab[onclick=&quot;showTab('${tabName}')&quot;]`).classList.add('active'); if (tabName === 'editor' &amp;&amp; appState.jsonEditor) { appState.jsonEditor.refresh(); } else if (tabName === 'history') { renderHistory(); } }
function showStatus(elementId, message, type = 'info', duration = 3000) { const statusEl = document.getElementById(elementId); if (!statusEl) return; statusEl.innerHTML = `&lt;div class=&quot;status-message ${type}&quot;&gt;${message}&lt;/div&gt;`; setTimeout(() =&gt; { if (statusEl.innerHTML.includes(message)) { statusEl.innerHTML = ''; } }, duration); }
function showModal(modalId, title, text, onConfirm, onCancel) { const modal = document.getElementById(modalId); if (!modal) return; if (modalId === 'modal') { appState.modal.lastFocusedElement = document.activeElement; modal.querySelector('#modalTitle').textContent = title; modal.querySelector('#modalText').textContent = text; appState.modal.onConfirm = () =&gt; { onConfirm(); hideModal('modal'); }; appState.modal.onCancel = onCancel || (() =&gt; hideModal('modal')); } modal.style.display = 'flex'; const firstFocusable = modal.querySelector('.button, a, input, select, textarea'); if (firstFocusable) firstFocusable.focus(); }
function hideModal(modalId) { const modal = document.getElementById(modalId); if (modal) modal.style.display = 'none'; if (modalId === 'modal' &amp;&amp; appState.modal.lastFocusedElement) { appState.modal.lastFocusedElement.focus(); } }
function handleModalKeydown(e, modalId) { const modal = document.getElementById(modalId); if (e.key !== 'Tab' || !modal || modal.style.display === 'none') return; const focusableElements = Array.from(modal.querySelectorAll('.button, a, input, select, textarea')); if (focusableElements.length === 0) return; const firstElement = focusableElements[0]; const lastElement = focusableElements[focusableElements.length - 1]; if (e.shiftKey) { if (document.activeElement === firstElement) { lastElement.focus(); e.preventDefault(); } } else { if (document.activeElement === lastElement) { firstElement.focus(); e.preventDefault(); } } }


// --- GAMIFICATION LOGIC ---
function loadUserProfile() { const savedProfile = localStorage.getItem('userProfile'); if (savedProfile) { appState.userProfile = JSON.parse(savedProfile); } updateHeaderProfile(); }
function saveUserProfile() { localStorage.setItem('userProfile', JSON.stringify(appState.userProfile)); }
function updateHeaderProfile() { const currentRank = getCurrentRank(); const nextRank = getNextRank(); document.getElementById('userRank').textContent = currentRank.name; let xpForNextRank = 0; let xpInCurrentRank = 0; if (nextRank) { xpForNextRank = nextRank.xp - currentRank.xp; xpInCurrentRank = appState.userProfile.xp - currentRank.xp; document.getElementById('userXP').textContent = `${xpInCurrentRank} / ${xpForNextRank}`; document.getElementById('xpBarInner').style.width = `${(xpInCurrentRank / xpForNextRank) * 100}%`; } else { document.getElementById('userXP').textContent = `${appState.userProfile.xp}`; document.getElementById('xpBarInner').style.width = '100%'; } }
function getCurrentRank() { let currentRank = RANKS[0]; for (const rank of RANKS) { if (appState.userProfile.xp &gt;= rank.xp) { currentRank = rank; } else { break; } } return currentRank; }
function getNextRank() { const currentRank = getCurrentRank(); const currentRankIndex = RANKS.findIndex(r =&gt; r.name === currentRank.name); return RANKS[currentRankIndex + 1] || null; }
function updateXP(xpGained) { const oldRank = getCurrentRank(); appState.userProfile.xp += xpGained; const newRank = getCurrentRank(); if (newRank.name !== oldRank.name) { launchConfetti(); showAchievementNotification({ title: `THƒÇNG H·∫†NG!`, desc: `B·∫°n ƒë√£ ƒë·∫°t h·∫°ng ${newRank.name}!`, icon: newRank.icon }); } saveUserProfile(); updateHeaderProfile(); }
function showStreakNotification(streakCount) { const notifier = document.getElementById('streakNotifier'); if (!notifier) return; notifier.querySelector('.streak-notifier-content').textContent = `üî• Chu·ªói x${streakCount}!`; notifier.classList.add('show'); setTimeout(() =&gt; { notifier.classList.remove('show'); }, 1500); }
function showAchievementNotification(achievement) { const notifier = document.getElementById('achievementNotifier'); if (!notifier) return; notifier.querySelector('.achievement-notifier-content').innerHTML = ` &lt;i class=&quot;fa-solid ${achievement.icon}&quot;&gt;&lt;/i&gt; &lt;div&gt; &lt;h4&gt;Th√†nh T√≠ch M·ªü Kh√≥a!&lt;/h4&gt; &lt;p&gt;${achievement.title}&lt;/p&gt; &lt;/div&gt; `; notifier.classList.add('show'); setTimeout(() =&gt; { notifier.classList.remove('show'); }, 4000); }
function unlockAchievement(achievementId) { if (!appState.userProfile.achievements.includes(achievementId)) { appState.userProfile.achievements.push(achievementId); saveUserProfile(); showAchievementNotification(ALL_ACHIEVEMENTS[achievementId]); renderAchievements(); } }
function renderAchievements() { const grid = document.getElementById('achievementGrid'); if (!grid) return; grid.innerHTML = Object.keys(ALL_ACHIEVEMENTS).map(key =&gt; { const achievement = ALL_ACHIEVEMENTS[key]; const isUnlocked = appState.userProfile.achievements.includes(key); return ` &lt;div class=&quot;achievement-card ${isUnlocked ? 'unlocked' : 'locked'}&quot;&gt; &lt;i class=&quot;fa-solid ${achievement.icon}&quot;&gt;&lt;/i&gt; &lt;h4&gt;${achievement.title}&lt;/h4&gt; &lt;p&gt;${achievement.desc}&lt;/p&gt; &lt;/div&gt; `; }).join(''); }

// --- GEMINI AI INTEGRATION ---
const GEMINI_API_KEY = &quot;AIzaSyDxX9uoPxerdY-iFqaiHvcInu_GFnyN2l4&quot;; const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`; async function callGeminiAPIWithExponentialBackoff(prompt, maxRetries = 5) { let delay = 1000; for (let i = 0; i &lt; maxRetries; i++) { try { const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ &quot;contents&quot;: [{ &quot;parts&quot;: [{ &quot;text&quot;: prompt }] }] }), }); if (response.status === 429) { await new Promise(resolve =&gt; setTimeout(resolve, delay)); delay *= 2; continue; } if (!response.ok) { const errorData = await response.json(); throw new Error(`API Error: ${errorData.error.message}`); } const result = await response.json(); if (!result.candidates || !result.candidates[0].content.parts[0].text) { throw new Error(&quot;Invalid response structure from API.&quot;); } return result.candidates[0].content.parts[0].text; } catch (error) { if (i === maxRetries - 1) throw error; await new Promise(resolve =&gt; setTimeout(resolve, delay)); delay *= 2; } } throw new Error(&quot;API call failed after multiple retries.&quot;); }

async function generateQuizWithAI() {
   const topic = document.getElementById('aiTopic').value;
   const numQuestions = document.getElementById('aiNumQuestions').value;
   const statusEl = document.getElementById('aiStatus');
   const generateBtn = document.getElementById('aiGenerateBtn');
   const aiActionsContainer = document.getElementById('aiActionsContainer');
   if (!topic.trim()) { showStatus('aiStatus', 'Vui l√≤ng nh·∫≠p ch·ªß ƒë·ªÅ.', 'error'); return; }
   if (!GEMINI_API_KEY) { showStatus('aiStatus', 'L·ªói: Vui l√≤ng cung c·∫•p API Key c·ªßa Gemini.', 'error', 5000); return; }
   statusEl.innerHTML = '&lt;div class=&quot;loader&quot; style=&quot;width:24px; height:24px; border-width:3px;&quot;&gt;&lt;/div&gt; &lt;p&gt;AI ƒëang ph√¢n t√≠ch v√† t·∫°o c√¢u h·ªèi...&lt;/p&gt;';
   generateBtn.disabled = true;
   aiActionsContainer.style.display = 'none';
   appState.creatorData.questions = [];
   renderCreatorUI();
   try {
       const createQuizPrompt = `
           H√£y t·∫°o m·ªôt b√†i ki·ªÉm tra tr·∫Øc nghi·ªám S√ÅNG T·∫†O v√† ƒêA D·∫†NG v·ªÅ ch·ªß ƒë·ªÅ: &quot;${topic}&quot;.
           Ng√¥n ng·ªØ v√† ƒë·ªô kh√≥ c·ªßa b√†i ki·ªÉm tra n√™n ph√π h·ª£p m·ªôt c√°ch t·ª± nhi√™n v·ªõi ch·ªß ƒë·ªÅ ƒë∆∞·ª£c cung c·∫•p. V√≠ d·ª•: n·∫øu ch·ªß ƒë·ªÅ l√† &quot;English literature&quot;, b√†i ki·ªÉm tra n√™n b·∫±ng ti·∫øng Anh.
           S·ªë l∆∞·ª£ng c√¢u h·ªèi: ${numQuestions}.
           Vui l√≤ng tr·∫£ v·ªÅ k·∫øt qu·∫£ d∆∞·ªõi d·∫°ng m·ªôt ƒë·ªëi t∆∞·ª£ng JSON duy nh·∫•t, kh√¥ng c√≥ b·∫•t k·ª≥ vƒÉn b·∫£n gi·∫£i th√≠ch n√†o kh√°c b√™n ngo√†i JSON.
           JSON ph·∫£i c√≥ c·∫•u tr√∫c ch√≠nh x√°c nh∆∞ sau, bao g·ªìm c√°c lo·∫°i c√¢u h·ªèi &quot;multiple-choice&quot;, &quot;multiple-selection&quot;, &quot;fill-in-the-blank&quot;, &quot;true-false&quot;, v√† &quot;matching&quot;:
           {
             &quot;title&quot;: &quot;M·ªôt ti√™u ƒë·ªÅ h·∫•p d·∫´n li√™n quan ƒë·∫øn ch·ªß ƒë·ªÅ&quot;,
             &quot;config&quot;: { &quot;timeLimit&quot;: 600, &quot;shuffleQuestions&quot;: true, &quot;shuffleOptions&quot;: true, &quot;instantFeedback&quot;: false, &quot;singleQuestionMode&quot;: false, &quot;autoNextQuestion&quot;: false },
             &quot;questions&quot;: [
               {
                 &quot;type&quot;: &quot;...&quot;,
                 &quot;question&quot;: &quot;N·ªôi dung c√¢u h·ªèi...&quot;,
                 &quot;imageUrl&quot;: &quot;URL h√¨nh ·∫£nh minh h·ªça (t√πy ch·ªçn, c√≥ th·ªÉ ƒë·ªÉ tr·ªëng)&quot;,
                 // D∆∞·ªõi ƒë√¢y l√† c·∫•u tr√∫c cho t·ª´ng lo·∫°i
                 // &quot;multiple-choice&quot;:
                 &quot;options&quot;: [&quot;L·ª±a ch·ªçn A&quot;, &quot;L·ª±a ch·ªçn B&quot;], &quot;correctAnswer&quot;: 0,
                 // &quot;multiple-selection&quot;:
                 &quot;options&quot;: [&quot;L·ª±a ch·ªçn A&quot;, &quot;L·ª±a ch·ªçn B&quot;, &quot;L·ª±a ch·ªçn C&quot;], &quot;correctAnswer&quot;: [0, 2],
                 // &quot;fill-in-the-blank&quot;:
                 &quot;correctAnswer&quot;: &quot;ƒë√°p √°n&quot;,
                 // &quot;true-false&quot;:
                 &quot;correctAnswer&quot;: true, // ho·∫∑c false
                 // &quot;matching&quot;:
                 &quot;prompts&quot;: [&quot;V·∫ø A1&quot;, &quot;V·∫ø A2&quot;], &quot;answers&quot;: [&quot;V·∫ø B1&quot;, &quot;V·∫ø B2&quot;], // prompts v√† answers ph·∫£i c√πng ƒë·ªô d√†i
                 // C√°c tr∆∞·ªùng chung
                 &quot;points&quot;: 10,
                 &quot;explanation&quot;: &quot;Gi·∫£i th√≠ch ng·∫Øn g·ªçn cho c√¢u tr·∫£ l·ªùi ƒë√∫ng.&quot;
               }
             ]
           }
           H√£y ƒë·∫£m b·∫£o r·∫±ng:
           - C√≥ s·ª± k·∫øt h·ª£p c·ªßa c√°c lo·∫°i c√¢u h·ªèi.
           - V·ªõi lo·∫°i &quot;matching&quot;, m·∫£ng &quot;prompts&quot; v√† &quot;answers&quot; c√≥ c√πng s·ªë l∆∞·ª£ng ph·∫ßn t·ª≠.
           - To√†n b·ªô ph·∫£n h·ªìi ch·ªâ l√† m·ªôt kh·ªëi m√£ JSON h·ª£p l·ªá.
       `;
       let jsonText = await callGeminiAPIWithExponentialBackoff(createQuizPrompt);
       jsonText = jsonText.replace(/```json/g, '').replace(/```/g, '').trim();
       const generatedQuiz = JSON.parse(jsonText);
       if (!generatedQuiz.questions || !Array.isArray(generatedQuiz.questions)) {
           throw new Error(&quot;ƒê·ªãnh d·∫°ng JSON do AI t·∫°o ra kh√¥ng h·ª£p l·ªá.&quot;);
       }
       appState.creatorData = { ...appState.creatorData, ...generatedQuiz, id: `quiz_${Date.now()}` };
       appState.creatorData.questions = generatedQuiz.questions.map(q =&gt; ({...q, id: Date.now() + Math.random()}));
       renderCreatorUI();
       showStatus('aiStatus', `‚úÖ ƒê√£ t·∫°o th√†nh c√¥ng ${generatedQuiz.questions.length} c√¢u h·ªèi!`, 'success');
       aiActionsContainer.style.display = 'flex';
       appState.hasUnsavedChanges = true;
       unlockAchievement('AI_ASSISTED');
   } catch (error) {
       console.error(&quot;L·ªói khi t·∫°o quiz b·∫±ng AI:&quot;, error);
       showStatus('aiStatus', `‚ùå ƒê√£ x·∫£y ra l·ªói: ${error.message}`, 'error', 6000);
   } finally {
       generateBtn.disabled = false;
   }
}

// --- QUIZ CREATOR LOGIC ---
function renderCreatorUI() {
   const questionsListEl = document.getElementById('questionsList');
   document.getElementById('creatorTitle').value = appState.creatorData.title;
   document.getElementById('creatorTimeLimit').value = appState.creatorData.config.timeLimit;
   document.getElementById('creatorShuffleQuestions').checked = appState.creatorData.config.shuffleQuestions;
   document.getElementById('creatorShuffleOptions').checked = appState.creatorData.config.shuffleOptions;
   document.getElementById('creatorInstantFeedback').checked = appState.creatorData.config.instantFeedback;
   document.getElementById('creatorSingleQuestionMode').checked = appState.creatorData.config.singleQuestionMode;
   document.getElementById('creatorAutoNextQuestion').checked = appState.creatorData.config.autoNextQuestion;
   handleSingleModeToggle(appState.creatorData.config.singleQuestionMode);

   if (appState.creatorData.questions.length === 0) {
       questionsListEl.innerHTML = `&lt;p style=&quot;text-align: center; opacity: 0.7;&quot;&gt;Ch∆∞a c√≥ c√¢u h·ªèi n√†o. H√£y d√πng AI ho·∫∑c th√™m th·ªß c√¥ng!&lt;/p&gt;`;
       return;
   }

   questionsListEl.innerHTML = appState.creatorData.questions.map((q, qIndex) =&gt; {
       let optionsHtml = '';
       if (q.type === 'multiple-choice' || q.type === 'multiple-selection') {
           const inputType = q.type === 'multiple-selection' ? 'checkbox' : 'radio';
           optionsHtml = `
               &lt;label&gt;C√°c l·ª±a ch·ªçn &amp; ƒê√°p √°n ƒë√∫ng&lt;/label&gt;
               ${(q.options || []).map((opt, oIndex) =&gt; `
                   &lt;div class=&quot;creator-option&quot;&gt;
                       &lt;input type=&quot;${inputType}&quot; name=&quot;correctAnswer_${q.id}&quot; onchange=&quot;updateCreatorCorrectAnswer(${qIndex}, ${oIndex})&quot; ${isCorrectAnswer(q, oIndex) ? 'checked' : ''}&gt;
                       &lt;input type=&quot;text&quot; value=&quot;${opt}&quot; placeholder=&quot;N·ªôi dung l·ª±a ch·ªçn ${oIndex + 1}&quot; oninput=&quot;updateCreatorOption(${qIndex}, ${oIndex}, this.value)&quot;&gt;
                       &lt;button class=&quot;button danger&quot; onclick=&quot;removeCreatorOption(${qIndex}, ${oIndex})&quot;&gt;&lt;i class=&quot;fa-solid fa-times&quot;&gt;&lt;/i&gt;&lt;/button&gt;
                   &lt;/div&gt;
               `).join('')}
               &lt;button class=&quot;button&quot; onclick=&quot;addCreatorOption(${qIndex})&quot;&gt;&lt;i class=&quot;fa-solid fa-plus&quot;&gt;&lt;/i&gt; Th√™m l·ª±a ch·ªçn&lt;/button&gt;
           `;
       } else if (q.type === 'fill-in-the-blank') {
           const answerValue = Array.isArray(q.correctAnswer) ? q.correctAnswer.join(';') : q.correctAnswer || '';
           optionsHtml = `
               &lt;div class=&quot;form-group&quot;&gt;
                   &lt;label&gt;ƒê√°p √°n ƒë√∫ng (ph√¢n c√°ch b·ªüi d·∫•u ; n·∫øu c√≥ nhi·ªÅu)&lt;/label&gt;
                   &lt;input type=&quot;text&quot; value=&quot;${answerValue}&quot; oninput=&quot;updateCreatorFillBlankAnswer(${qIndex}, this.value)&quot;&gt;
               &lt;/div&gt;
           `;
       } else if (q.type === 'true-false') {
            optionsHtml = `
               &lt;label&gt;ƒê√°p √°n ƒë√∫ng&lt;/label&gt;
               &lt;div class=&quot;button-group&quot; style=&quot;justify-content: flex-start;&quot;&gt;
                   &lt;input type=&quot;radio&quot; id=&quot;true_${q.id}&quot; name=&quot;correctAnswer_${q.id}&quot; onchange=&quot;updateCreatorTrueFalseAnswer(${qIndex}, true)&quot; ${q.correctAnswer === true ? 'checked' : ''}&gt;
                   &lt;label for=&quot;true_${q.id}&quot; style=&quot;margin-bottom:0;&quot;&gt;ƒê√∫ng&lt;/label&gt;
                   &lt;input type=&quot;radio&quot; id=&quot;false_${q.id}&quot; name=&quot;correctAnswer_${q.id}&quot; onchange=&quot;updateCreatorTrueFalseAnswer(${qIndex}, false)&quot; ${q.correctAnswer === false ? 'checked' : ''}&gt;
                   &lt;label for=&quot;false_${q.id}&quot; style=&quot;margin-bottom:0;&quot;&gt;Sai&lt;/label&gt;
               &lt;/div&gt;
           `;
       } else if (q.type === 'matching') {
           optionsHtml = `
               &lt;label&gt;C√°c c·∫∑p Gh√©p ƒë√¥i&lt;/label&gt;
               ${(q.prompts || []).map((prompt, pIndex) =&gt; `
                   &lt;div class=&quot;creator-matching-pair&quot;&gt;
                       &lt;input type=&quot;text&quot; value=&quot;${prompt}&quot; placeholder=&quot;V·∫ø A ${pIndex + 1}&quot; oninput=&quot;updateCreatorMatching(${qIndex}, ${pIndex}, 'prompts', this.value)&quot;&gt;
                       &lt;input type=&quot;text&quot; value=&quot;${q.answers[pIndex] || ''}&quot; placeholder=&quot;V·∫ø B ${pIndex + 1}&quot; oninput=&quot;updateCreatorMatching(${qIndex}, ${pIndex}, 'answers', this.value)&quot;&gt;
                       &lt;button class=&quot;button danger&quot; onclick=&quot;removeCreatorMatchingPair(${qIndex}, ${pIndex})&quot;&gt;&lt;i class=&quot;fa-solid fa-times&quot;&gt;&lt;/i&gt;&lt;/button&gt;
                   &lt;/div&gt;
               `).join('')}
               &lt;button class=&quot;button&quot; onclick=&quot;addCreatorMatchingPair(${qIndex})&quot;&gt;&lt;i class=&quot;fa-solid fa-plus&quot;&gt;&lt;/i&gt; Th√™m c·∫∑p&lt;/button&gt;
           `;
       }

       return `
           &lt;div class=&quot;creator-question&quot; data-index=&quot;${qIndex}&quot;&gt;
               &lt;div style=&quot;display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;&quot;&gt;
                   &lt;label style=&quot;margin: 0;&quot;&gt;&lt;strong&gt;C√¢u h·ªèi ${qIndex + 1}&lt;/strong&gt;&lt;/label&gt;
                   &lt;button type=&quot;button&quot; class=&quot;button danger&quot; onclick=&quot;removeCreatorQuestion(${qIndex})&quot;&gt;&lt;i class=&quot;fa-solid fa-trash&quot;&gt;&lt;/i&gt; X√≥a c√¢u h·ªèi&lt;/button&gt;
               &lt;/div&gt;
               &lt;div class=&quot;form-group&quot;&gt;
                   &lt;label&gt;Lo·∫°i c√¢u h·ªèi&lt;/label&gt;
                   &lt;select onchange=&quot;updateQuestionType(${qIndex}, this.value)&quot;&gt;
                       &lt;option value=&quot;multiple-choice&quot; ${q.type === 'multiple-choice' ? 'selected' : ''}&gt;M·ªôt ƒë√°p √°n&lt;/option&gt;
                       &lt;option value=&quot;multiple-selection&quot; ${q.type === 'multiple-selection' ? 'selected' : ''}&gt;Nhi·ªÅu ƒë√°p √°n&lt;/option&gt;
                       &lt;option value=&quot;fill-in-the-blank&quot; ${q.type === 'fill-in-the-blank' ? 'selected' : ''}&gt;ƒêi·ªÅn v√†o ch·ªó tr·ªëng&lt;/option&gt;
                       &lt;option value=&quot;true-false&quot; ${q.type === 'true-false' ? 'selected' : ''}&gt;ƒê√∫ng / Sai&lt;/option&gt;
                       &lt;option value=&quot;matching&quot; ${q.type === 'matching' ? 'selected' : ''}&gt;N·ªëi C·ªôt&lt;/option&gt;
                   &lt;/select&gt;
               &lt;/div&gt;
               &lt;div class=&quot;form-group&quot;&gt;
                   &lt;label&gt;N·ªôi dung c√¢u h·ªèi&lt;/label&gt;
                   &lt;textarea oninput=&quot;updateCreatorField(${qIndex}, 'question', this.value)&quot; rows=&quot;2&quot;&gt;${q.question || ''}&lt;/textarea&gt;
               &lt;/div&gt;
               &lt;div class=&quot;form-group&quot;&gt;
                   &lt;label&gt;URL H√¨nh ·∫£nh (t√πy ch·ªçn)&lt;/label&gt;
                   &lt;input type=&quot;text&quot; placeholder=&quot;https://example.com/image.png&quot; value=&quot;${q.imageUrl || ''}&quot; oninput=&quot;updateCreatorField(${qIndex}, 'imageUrl', this.value)&quot;&gt;
               &lt;/div&gt;
               ${optionsHtml}
           &lt;/div&gt;
       `;
   }).join('');
}

function isCorrectAnswer(question, optionIndex) { if (question.type === 'multiple-selection') { return Array.isArray(question.correctAnswer) &amp;&amp; question.correctAnswer.includes(optionIndex); } return question.correctAnswer === optionIndex; }
function updateCreatorConfig(field, value) { if (field === 'title') { appState.creatorData.title = value; } else { appState.creatorData.config[field] = value; } appState.hasUnsavedChanges = true; }
function handleSingleModeToggle(isChecked) { updateCreatorConfig('singleQuestionMode', isChecked); const autoNextCheckbox = document.getElementById('creatorAutoNextQuestion'); const autoNextLabel = document.getElementById('creatorAutoNextQuestionLabel'); autoNextCheckbox.disabled = !isChecked; autoNextLabel.toggleAttribute('disabled', !isChecked); if (!isChecked) { autoNextCheckbox.checked = false; updateCreatorConfig('autoNextQuestion', false); } }
function updateCreatorField(qIndex, field, value) { appState.creatorData.questions[qIndex][field] = value; appState.hasUnsavedChanges = true; }
function updateCreatorFillBlankAnswer(qIndex, value) { const answers = value.split(';').map(s =&gt; s.trim()).filter(Boolean); appState.creatorData.questions[qIndex].correctAnswer = answers.length &gt; 1 ? answers : answers[0] || &quot;&quot;; appState.hasUnsavedChanges = true; }
function updateCreatorTrueFalseAnswer(qIndex, value) { appState.creatorData.questions[qIndex].correctAnswer = value; appState.hasUnsavedChanges = true; }
function updateQuestionType(qIndex, type) { const q = appState.creatorData.questions[qIndex]; q.type = type; q.correctAnswer = undefined; delete q.options; delete q.prompts; delete q.answers; if (type === 'multiple-selection') { q.correctAnswer = []; q.options = [&quot;L·ª±a ch·ªçn 1&quot;, &quot;L·ª±a ch·ªçn 2&quot;]; } else if (type === 'multiple-choice') { q.correctAnswer = 0; q.options = [&quot;L·ª±a ch·ªçn 1&quot;, &quot;L·ª±a ch·ªçn 2&quot;]; } else if (type === 'fill-in-the-blank') { q.correctAnswer = &quot;&quot;; } else if (type === 'true-false') { q.correctAnswer = true; } else if (type === 'matching') { q.prompts = [&quot;V·∫ø A1&quot;, &quot;V·∫ø A2&quot;]; q.answers = [&quot;V·∫ø B1&quot;, &quot;V·∫ø B2&quot;]; } appState.hasUnsavedChanges = true; renderCreatorUI(); }
function creatorAddQuestion() { appState.creatorData.questions.push({ id: Date.now(), type: &quot;multiple-choice&quot;, question: &quot;&quot;, options: [&quot;L·ª±a ch·ªçn 1&quot;, &quot;L·ª±a ch·ªçn 2&quot;], correctAnswer: 0, points: 10, explanation: &quot;&quot;, imageUrl: &quot;&quot; }); appState.hasUnsavedChanges = true; renderCreatorUI(); }
function removeCreatorQuestion(index) { appState.creatorData.questions.splice(index, 1); appState.hasUnsavedChanges = true; renderCreatorUI(); }
function addCreatorOption(qIndex) { if (!appState.creatorData.questions[qIndex].options) { appState.creatorData.questions[qIndex].options = []; } appState.creatorData.questions[qIndex].options.push(&quot;L·ª±a ch·ªçn m·ªõi&quot;); appState.hasUnsavedChanges = true; renderCreatorUI(); }
function removeCreatorOption(qIndex, oIndex) { appState.creatorData.questions[qIndex].options.splice(oIndex, 1); appState.hasUnsavedChanges = true; renderCreatorUI(); }
function updateCreatorOption(qIndex, oIndex, value) { appState.creatorData.questions[qIndex].options[oIndex] = value; appState.hasUnsavedChanges = true; }
function updateCreatorCorrectAnswer(qIndex, oIndex) { const q = appState.creatorData.questions[qIndex]; if (q.type === 'multiple-selection') { if (!Array.isArray(q.correctAnswer)) q.correctAnswer = []; const pos = q.correctAnswer.indexOf(oIndex); if (pos === -1) { q.correctAnswer.push(oIndex); } else { q.correctAnswer.splice(pos, 1); } } else { q.correctAnswer = oIndex; } appState.hasUnsavedChanges = true; }
function addCreatorMatchingPair(qIndex) { const q = appState.creatorData.questions[qIndex]; if (!q.prompts) q.prompts = []; if (!q.answers) q.answers = []; q.prompts.push(&quot;&quot;); q.answers.push(&quot;&quot;); appState.hasUnsavedChanges = true; renderCreatorUI(); }
function removeCreatorMatchingPair(qIndex, pIndex) { const q = appState.creatorData.questions[qIndex]; q.prompts.splice(pIndex, 1); q.answers.splice(pIndex, 1); appState.hasUnsavedChanges = true; renderCreatorUI(); }
function updateCreatorMatching(qIndex, pIndex, field, value) { appState.creatorData.questions[qIndex][field][pIndex] = value; appState.hasUnsavedChanges = true; }
function generateJsonAndSwitch() { appState.jsonEditor.setValue(JSON.stringify(appState.creatorData, null, 4)); showStatus('editorStatus', '‚úÖ ƒê√£ t·∫°o JSON t·ª´ X∆∞·ªüng Ch·∫ø T·∫°o!', 'success'); showTab('editor'); }
function startQuizFromCreator() { appState.currentQuizData = JSON.parse(JSON.stringify(appState.creatorData)); try { validateQuizData(appState.currentQuizData); appState.userAnswers = {}; appState.hasUnsavedChanges = false; initializeQuiz(); showTab('quiz'); } catch(error) { showModal('modal', 'L·ªói D·ªØ Li·ªáu', `Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu: ${error.message}`, () =&gt; {}); } }

// --- JSON VALIDATION &amp; FILE HANDLING ---
function validateQuizData(data) { if (!data || typeof data !== 'object') throw new Error('D·ªØ li·ªáu kh√¥ng ph·∫£i l√† m·ªôt ƒë·ªëi t∆∞·ª£ng JSON.'); if (typeof data.title !== 'string') throw new Error('Thi·∫øu ho·∫∑c sai ƒë·ªãnh d·∫°ng &quot;title&quot;.'); if (!data.config || typeof data.config !== 'object') throw new Error('Thi·∫øu ho·∫∑c sai ƒë·ªãnh d·∫°ng &quot;config&quot;.'); if (!Array.isArray(data.questions)) throw new Error('Thi·∫øu ho·∫∑c sai ƒë·ªãnh d·∫°ng &quot;questions&quot;.'); if (data.questions.length === 0) throw new Error('Danh s√°ch &quot;questions&quot; kh√¥ng ƒë∆∞·ª£c r·ªóng.'); data.questions.forEach((q, index) =&gt; { if (!q.type || !q.question) throw new Error(`C√¢u h·ªèi ${index + 1} thi·∫øu type ho·∫∑c question.`); if (['multiple-choice', 'multiple-selection'].includes(q.type) &amp;&amp; !Array.isArray(q.options)) throw new Error(`C√¢u h·ªèi ${index + 1} thi·∫øu &quot;options&quot;.`); if (q.type === 'matching' &amp;&amp; (!Array.isArray(q.prompts) || !Array.isArray(q.answers) || q.prompts.length !== q.answers.length)) throw new Error(`C√¢u h·ªèi ${index + 1} (N·ªëi c·ªôt) c√≥ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá.`); if (q.correctAnswer === undefined &amp;&amp; q.type !== 'matching') throw new Error(`C√¢u h·ªèi ${index + 1} thi·∫øu &quot;correctAnswer&quot;.`); if (!q.id) q.id = Date.now() + index; }); return true; }
function loadQuestionsFromJson() { try { const quizData = JSON.parse(appState.jsonEditor.getValue()); validateQuizData(quizData); appState.currentQuizData = quizData; appState.userAnswers = {}; localStorage.setItem('quizJson', appState.jsonEditor.getValue()); showStatus('editorStatus', `‚úÖ ƒê√£ t·∫£i ${quizData.questions.length} c√¢u h·ªèi!`, 'success'); initializeQuiz(); showTab('quiz'); } catch (error) { showStatus('editorStatus', `‚ùå L·ªói JSON: ${error.message}`, 'error'); } }
function loadSampleQuestions() { const sampleData = { &quot;title&quot;: &quot;H√†nh Tr√¨nh Kh√°m Ph√° V≈© Tr·ª•&quot;, &quot;config&quot;: { &quot;timeLimit&quot;: 600, &quot;shuffleQuestions&quot;: true, &quot;shuffleOptions&quot;: true, &quot;instantFeedback&quot;: false, &quot;singleQuestionMode&quot;: true, &quot;autoNextQuestion&quot;: true }, &quot;questions&quot;: [ { &quot;id&quot;: 1, &quot;type&quot;: &quot;multiple-choice&quot;, &quot;question&quot;: &quot;H√†nh tinh n√†o ƒë∆∞·ª£c m·ªánh danh l√† 'H√†nh tinh ƒê·ªè'?&quot;, &quot;imageUrl&quot;: &quot;https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/OSIRIS_Mars_true_color.jpg/800px-OSIRIS_Mars_true_color.jpg&quot;, &quot;options&quot;: [&quot;Sao H·ªèa&quot;, &quot;Sao Kim&quot;, &quot;Sao M·ªôc&quot;, &quot;Sao Th·ªï&quot;], &quot;correctAnswer&quot;: 0, &quot;explanation&quot;: &quot;Sao H·ªèa c√≥ b·ªÅ m·∫∑t m√†u ƒë·ªè do oxit s·∫Øt.&quot;, &quot;points&quot;: 10 }, { &quot;id&quot;: 2, &quot;type&quot;: &quot;true-false&quot;, &quot;question&quot;: &quot;M·∫∑t Tr·ªùi l√† m·ªôt h√†nh tinh.&quot;, &quot;correctAnswer&quot;: false, &quot;explanation&quot;: &quot;M·∫∑t Tr·ªùi l√† m·ªôt ng√¥i sao, kh√¥ng ph·∫£i m·ªôt h√†nh tinh.&quot;, &quot;points&quot;: 5 }, { &quot;id&quot;: 3, &quot;type&quot;: &quot;multiple-selection&quot;, &quot;question&quot;: &quot;Ch·ªçn nh·ªØng h√†nh tinh kh√≠ kh·ªïng l·ªì:&quot;, &quot;imageUrl&quot;: &quot;&quot;, &quot;options&quot;: [&quot;Sao M·ªôc&quot;, &quot;Sao H·ªèa&quot;, &quot;Sao Th·ªï&quot;, &quot;Tr√°i ƒê·∫•t&quot;], &quot;correctAnswer&quot;: [0, 2], &quot;explanation&quot;: &quot;Sao M·ªôc v√† Sao Th·ªï l√† c√°c h√†nh tinh kh√≠ kh·ªïng l·ªì.&quot;, &quot;points&quot;: 20 }, { &quot;id&quot;: 4, &quot;type&quot;: &quot;fill-in-the-blank&quot;, &quot;question&quot;: &quot;Thi√™n h√† c·ªßa ch√∫ng ta c√≥ t√™n l√† g√¨? (Ti·∫øng Anh)&quot;, &quot;imageUrl&quot;: &quot;&quot;, &quot;correctAnswer&quot;: [&quot;Milky Way&quot;, &quot;The Milky Way&quot;], &quot;explanation&quot;: &quot;Thi√™n h√† c·ªßa ch√∫ng ta t√™n l√† Milky Way, hay c√≤n g·ªçi l√† D·∫£i Ng√¢n H√†.&quot;, &quot;points&quot;: 15 }, { &quot;id&quot;: 5, &quot;type&quot;: &quot;matching&quot;, &quot;question&quot;: &quot;Gh√©p c√°c nh√† thi√™n vƒÉn h·ªçc v·ªõi kh√°m ph√° c·ªßa h·ªç.&quot;, &quot;prompts&quot;: [&quot;Ng∆∞·ªùi ƒë·∫ßu ti√™n ƒëi v√†o v≈© tr·ª•&quot;, &quot;Ph√°t hi·ªán ra c√°c ƒë·ªãnh lu·∫≠t chuy·ªÉn ƒë·ªông c·ªßa h√†nh tinh&quot;, &quot;Thuy·∫øt Nh·∫≠t t√¢m&quot;], &quot;answers&quot;: [&quot;Yuri Gagarin&quot;, &quot;Johannes Kepler&quot;, &quot;Nicolaus Copernicus&quot;], &quot;explanation&quot;: &quot;ƒê√¢y l√† nh·ªØng c·ªôt m·ªëc quan tr·ªçng trong l·ªãch s·ª≠ thi√™n vƒÉn h·ªçc.&quot;, &quot;points&quot;: 25 } ] }; appState.jsonEditor.setValue(JSON.stringify(sampleData, null, 4)); }
function copyJson() { navigator.clipboard.writeText(appState.jsonEditor.getValue()).then(() =&gt; showStatus('editorStatus', '‚úÖ ƒê√£ sao ch√©p!', 'success')); }
function confirmClearEditor() { showModal('modal', 'X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô n·ªôi dung trong tr√¨nh so·∫°n th·∫£o?', () =&gt; { appState.jsonEditor.setValue(''); localStorage.removeItem('quizJson'); }); }
function exportJsonToFile() { try { const jsonString = appState.jsonEditor.getValue(); JSON.parse(jsonString); const title = (JSON.parse(jsonString)?.title || 'quiz').replace(/[^a-z0-9]/gi, '_').toLowerCase(); const blob = new Blob([jsonString], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${title}.json`; a.click(); URL.revokeObjectURL(a.href); showStatus('editorStatus', '‚úÖ ƒê√£ export th√†nh c√¥ng!', 'success'); } catch (error) { showStatus('editorStatus', `‚ùå Kh√¥ng th·ªÉ export: JSON kh√¥ng h·ª£p l·ªá.`, 'error'); } }
function importJsonFromFile(event) { const file = event.target.files[0]; if (!file) return; processImportedFile(file); }
function handleFileDrop(event) { if (event.dataTransfer.files &amp;&amp; event.dataTransfer.files[0]) { const file = event.dataTransfer.files[0]; if (file.type === &quot;application/json&quot;) { processImportedFile(file); } else { showStatus('editorStatus', '‚ùå L·ªói: Vui l√≤ng ch·ªâ th·∫£ file .json.', 'error'); } } }
function processImportedFile(file) { const reader = new FileReader(); reader.onload = e =&gt; { try { const importedData = JSON.parse(e.target.result); validateQuizData(importedData); appState.jsonEditor.setValue(JSON.stringify(importedData, null, 4)); showStatus('editorStatus', `‚úÖ ƒê√£ import ${file.name}!`, 'success'); } catch (error) { showStatus('editorStatus', `‚ùå File JSON kh√¥ng h·ª£p l·ªá: ${error.message}`, 'error'); } }; reader.readAsText(file); const fileInput = document.getElementById('fileInput'); if (fileInput) fileInput.value = ''; }

// --- QUIZ LOGIC ---
function initializeQuiz() { const savedProgress = sessionStorage.getItem('quizProgress'); if (savedProgress) { showModal( 'modal', 'Ti·∫øp t·ª•c b√†i l√†m?', 'Ch√∫ng t√¥i t√¨m th·∫•y m·ªôt b√†i l√†m ƒëang dang d·ªü. B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c kh√¥ng?', () =&gt; { loadQuizProgress(); }, () =&gt; { startNewQuiz(); } ); } else { startNewQuiz(); } }
function startNewQuiz() { clearQuizProgress(); const { config, questions } = appState.currentQuizData; appState.quizStartTime = new Date(); appState.isPaused = false; appState.userAnswers = {}; appState.currentQuestionIndex = 0; appState.shuffledQuestions = config.shuffleQuestions ? shuffleArray(questions) : [...questions]; appState.shuffledOptions = {}; appState.currentStreak = 0; appState.longestStreak = 0; renderQuizUI(); if (config.timeLimit &gt; 0) startTimer(config.timeLimit); }
function renderQuizUI() { const { config } = appState.currentQuizData; if (config.singleQuestionMode) { renderQuizSingleView(); } else { renderQuizListView(); } }
function renderQuizListView() { const quizContent = document.getElementById('quizContent'); const { title, config } = appState.currentQuizData; const questionsHtml = appState.shuffledQuestions.map((q, index) =&gt; { return generateQuestionCardHtml(q, index); }).join(''); quizContent.innerHTML = ` &lt;div class=&quot;quiz-header&quot;&gt; &lt;h2&gt;${title || 'ƒê·ªÅ thi'}&lt;/h2&gt; ${config.timeLimit &gt; 0 ? `&lt;p&gt;‚è∞ Th·ªùi gian: &lt;b id=&quot;timer&quot;&gt;${formatTime(appState.timeLeft || config.timeLimit)}&lt;/b&gt;&lt;/p&gt;` : ''} &lt;div class=&quot;progress-bar&quot;&gt;&lt;div id=&quot;progressBarInner&quot; class=&quot;progress-bar-inner&quot;&gt;&lt;/div&gt;&lt;/div&gt; &lt;/div&gt; &lt;div id=&quot;questions-list-container&quot;&gt;${questionsHtml}&lt;/div&gt; &lt;div class=&quot;quiz-button-container button-group&quot; style=&quot;margin-top: 0;&quot;&gt; ${config.timeLimit &gt; 0 ? `&lt;button class=&quot;button warning&quot; id=&quot;pauseBtn&quot; onclick=&quot;pauseQuiz()&quot;&gt;&lt;i class=&quot;fa-solid fa-pause&quot;&gt;&lt;/i&gt; T·∫°m D·ª´ng&lt;/button&gt;` : ''} &lt;button class=&quot;button secondary&quot; id=&quot;submitBtn&quot; onclick=&quot;confirmSubmitQuiz()&quot;&gt;&lt;i class=&quot;fa-solid fa-flag-checkered&quot;&gt;&lt;/i&gt; N·ªôp B√†i&lt;/button&gt; &lt;/div&gt;`; const listContainer = document.getElementById('questions-list-container'); listContainer.addEventListener('change', handleQuizAnswer); listContainer.addEventListener('input', handleQuizAnswer); updateProgress(); restoreUserInputs(); }
function renderQuizSingleView() { const quizContent = document.getElementById('quizContent'); const { title, config } = appState.currentQuizData; const q = appState.shuffledQuestions[appState.currentQuestionIndex]; const questionHtml = generateQuestionCardHtml(q, appState.currentQuestionIndex); const navDotsHtml = appState.shuffledQuestions.map((_, index) =&gt; `&lt;div class=&quot;nav-dot ${index === appState.currentQuestionIndex ? 'current' : ''} ${appState.userAnswers[appState.shuffledQuestions[index].id] !== undefined ? 'answered' : ''}&quot; onclick=&quot;goToQuestion(${index})&quot;&gt;${index + 1}&lt;/div&gt;` ).join(''); quizContent.innerHTML = ` &lt;div class=&quot;quiz-header&quot;&gt; &lt;h2&gt;${title || 'ƒê·ªÅ thi'}&lt;/h2&gt; ${config.timeLimit &gt; 0 ? `&lt;p&gt;‚è∞ Th·ªùi gian: &lt;b id=&quot;timer&quot;&gt;${formatTime(appState.timeLeft || config.timeLimit)}&lt;/b&gt;&lt;/p&gt;` : ''} &lt;div class=&quot;progress-bar&quot;&gt;&lt;div id=&quot;progressBarInner&quot; class=&quot;progress-bar-inner&quot;&gt;&lt;/div&gt;&lt;/div&gt; &lt;/div&gt; &lt;div id=&quot;single-question-view&quot;&gt; &lt;div id=&quot;sq-question-container&quot;&gt;${questionHtml}&lt;/div&gt; &lt;div id=&quot;sq-navigation&quot;&gt; &lt;button class=&quot;button&quot; onclick=&quot;prevQuestion()&quot; ${appState.currentQuestionIndex === 0 ? 'disabled' : ''}&gt;&lt;i class=&quot;fa-solid fa-arrow-left&quot;&gt;&lt;/i&gt; Tr∆∞·ªõc&lt;/button&gt; &lt;div id=&quot;sq-nav-dots&quot;&gt;${navDotsHtml}&lt;/div&gt; &lt;/div&gt; &lt;/div&gt;`; const questionContainer = document.getElementById('sq-question-container'); questionContainer.addEventListener('change', handleQuizAnswer); questionContainer.addEventListener('input', handleQuizAnswer); if (q.type === 'fill-in-the-blank') { const inputEl = questionContainer.querySelector(`input[data-question-id=&quot;${q.id}&quot;]`); if (inputEl) { inputEl.addEventListener('keydown', (e) =&gt; { if (e.key === 'Enter') { e.preventDefault(); handleAutoNext(); } }); } } updateProgress(); restoreUserInputs(); }

function generateQuestionCardHtml(q, index) {
   let optionsHtml = '';
   const { config } = appState.currentQuizData;

   if (q.type === 'multiple-choice' || q.type === 'multiple-selection') {
       if (!appState.shuffledOptions[q.id]) {
           let options = q.options.map((opt, i) =&gt; ({ text: opt, originalIndex: i }));
           appState.shuffledOptions[q.id] = config.shuffleOptions ? shuffleArray(options) : options;
       }
       const currentShuffledOptions = appState.shuffledOptions[q.id];
       optionsHtml = currentShuffledOptions.map((opt, i) =&gt; {
           const inputType = q.type === 'multiple-choice' ? 'radio' : 'checkbox';
           const inputId = `q${q.id}_opt${i}`;
           return `&lt;li class=&quot;option&quot;&gt;&lt;input type=&quot;${inputType}&quot; id=&quot;${inputId}&quot; name=&quot;q_${q.id}&quot; value=&quot;${opt.originalIndex}&quot; data-question-id=&quot;${q.id}&quot;&gt;&lt;label for=&quot;${inputId}&quot;&gt;${opt.text}&lt;/label&gt;&lt;/li&gt;`;
       }).join('');
   } else if (q.type === 'true-false') {
       optionsHtml = `
           &lt;li class=&quot;option&quot;&gt;&lt;input type=&quot;radio&quot; id=&quot;q${q.id}_opt_true&quot; name=&quot;q_${q.id}&quot; value=&quot;true&quot; data-question-id=&quot;${q.id}&quot;&gt;&lt;label for=&quot;q${q.id}_opt_true&quot;&gt;ƒê√∫ng&lt;/label&gt;&lt;/li&gt;
           &lt;li class=&quot;option&quot;&gt;&lt;input type=&quot;radio&quot; id=&quot;q${q.id}_opt_false&quot; name=&quot;q_${q.id}&quot; value=&quot;false&quot; data-question-id=&quot;${q.id}&quot;&gt;&lt;label for=&quot;q${q.id}_opt_false&quot;&gt;Sai&lt;/label&gt;&lt;/li&gt;
       `;
   } else if (q.type === 'fill-in-the-blank') {
       optionsHtml = `&lt;div class=&quot;form-group&quot;&gt;&lt;input type=&quot;text&quot; placeholder=&quot;Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n...&quot; data-question-id=&quot;${q.id}&quot;&gt;&lt;/div&gt;`;
   } else if (q.type === 'matching') {
       if (!appState.shuffledOptions[q.id]) {
           let answers = q.answers.map((ans, i) =&gt; ({ text: ans, originalIndex: i }));
           appState.shuffledOptions[q.id] = config.shuffleOptions ? shuffleArray(answers) : answers;
       }
       const shuffledAnswers = appState.shuffledOptions[q.id];
       optionsHtml = `
           &lt;div class=&quot;matching-grid&quot;&gt;
               ${q.prompts.map((prompt, pIndex) =&gt; `
                   &lt;div class=&quot;matching-item&quot;&gt;
                       &lt;p&gt;${prompt}&lt;/p&gt;
                       &lt;i class=&quot;fa-solid fa-arrows-left-right&quot;&gt;&lt;/i&gt;
                       &lt;select data-question-id=&quot;${q.id}&quot; data-prompt-index=&quot;${pIndex}&quot;&gt;
                           &lt;option value=&quot;&quot;&gt;Ch·ªçn ƒë√°p √°n...&lt;/option&gt;
                           ${shuffledAnswers.map((ans, aIndex) =&gt; `&lt;option value=&quot;${ans.originalIndex}&quot;&gt;${ans.text}&lt;/option&gt;`).join('')}
                       &lt;/select&gt;
                   &lt;/div&gt;
               `).join('')}
           &lt;/div&gt;
       `;
   }

   let cardNavHtml = '';
   if (config.singleQuestionMode) {
       const isLastQuestion = index === appState.shuffledQuestions.length - 1;
       if (isLastQuestion) {
           cardNavHtml = `&lt;div class=&quot;sq-card-nav&quot;&gt; &lt;button class=&quot;button secondary&quot; id=&quot;submitBtn&quot; onclick=&quot;confirmSubmitQuiz()&quot;&gt;&lt;i class=&quot;fa-solid fa-flag-checkered&quot;&gt;&lt;/i&gt; N·ªôp B√†i&lt;/button&gt; &lt;/div&gt;`;
       } else {
           cardNavHtml = `&lt;div class=&quot;sq-card-nav&quot;&gt; &lt;button class=&quot;button&quot; onclick=&quot;nextQuestion()&quot;&gt;&lt;i class=&quot;fa-solid fa-arrow-right&quot;&gt;&lt;/i&gt; Ti·∫øp&lt;/button&gt; &lt;/div&gt;`;
       }
   }
   return `&lt;div class=&quot;question-card&quot; id=&quot;card_${q.id}&quot; style=&quot;animation-delay: 50ms&quot;&gt; &lt;p&gt;&lt;strong&gt;C√¢u ${index + 1}:&lt;/strong&gt;&lt;/p&gt; &lt;div class=&quot;question-text&quot;&gt;${q.question}&lt;/div&gt; ${q.imageUrl ? `&lt;img src=&quot;${q.imageUrl}&quot; alt=&quot;H√¨nh ·∫£nh c√¢u h·ªèi&quot; class=&quot;question-image&quot; loading=&quot;lazy&quot; onerror=&quot;this.style.display='none'&quot;&gt;` : ''} &lt;div class=&quot;options&quot;&gt;${optionsHtml}&lt;/div&gt; &lt;div class=&quot;instant-explanation&quot; id=&quot;exp_${q.id}&quot;&gt;${q.explanation || ''}&lt;/div&gt; ${cardNavHtml} &lt;/div&gt;`;
}

function restoreUserInputs() {
   Object.keys(appState.userAnswers).forEach(questionId =&gt; {
       const answer = appState.userAnswers[questionId];
       const q = appState.shuffledQuestions.find(q =&gt; q.id == questionId);
       if (!q) return;

       if (q.type === 'multiple-selection') {
           answer.forEach(val =&gt; { const input = document.querySelector(`input[data-question-id=&quot;${questionId}&quot;][value=&quot;${val}&quot;]`); if (input) input.checked = true; });
       } else if (q.type === 'multiple-choice') {
           const input = document.querySelector(`input[data-question-id=&quot;${questionId}&quot;][value=&quot;${answer}&quot;]`); if (input) input.checked = true;
       } else if (q.type === 'true-false') {
           const input = document.querySelector(`input[data-question-id=&quot;${questionId}&quot;][value=&quot;${answer}&quot;]`); if (input) input.checked = true;
       } else if (q.type === 'fill-in-the-blank') {
           const input = document.querySelector(`input[data-question-id=&quot;${questionId}&quot;]`); if (input) input.value = answer;
       } else if (q.type === 'matching') {
           answer.forEach((ans, index) =&gt; {
               const select = document.querySelector(`select[data-question-id=&quot;${questionId}&quot;][data-prompt-index=&quot;${index}&quot;]`);
               if (select) select.value = ans;
           });
       }
   });
}
function goToQuestion(index) { if (index &gt;= 0 &amp;&amp; index &lt; appState.shuffledQuestions.length) { appState.currentQuestionIndex = index; renderQuizSingleView(); } }
function nextQuestion() { goToQuestion(appState.currentQuestionIndex + 1); }
function prevQuestion() { goToQuestion(appState.currentQuestionIndex - 1); }

function handleQuizAnswer(event) {
   const input = event.target;
   const questionId = input.dataset.questionId;
   if (questionId === undefined) return;
   
   const card = document.getElementById(`card_${questionId}`);
   if (card &amp;&amp; card.classList.contains('answered')) return;

   const q = appState.currentQuizData.questions.find(q =&gt; q.id == questionId);
   if (!q) return;

   if (q.type === 'multiple-selection') {
       if (!appState.userAnswers[q.id] || !Array.isArray(appState.userAnswers[q.id])) { appState.userAnswers[q.id] = []; }
       const value = parseInt(input.value);
       if (input.checked) { appState.userAnswers[q.id].push(value); } else { appState.userAnswers[q.id] = appState.userAnswers[q.id].filter(v =&gt; v !== value); }
       if(appState.userAnswers[q.id].length === 0) delete appState.userAnswers[q.id];
   } else if (q.type === 'multiple-choice') {
       appState.userAnswers[q.id] = parseInt(input.value);
   } else if (q.type === 'true-false') {
       appState.userAnswers[q.id] = (input.value === 'true');
   } else if (q.type === 'fill-in-the-blank') {
       if (input.value.trim()) { appState.userAnswers[q.id] = input.value; } else { delete appState.userAnswers[q.id]; }
   } else if (q.type === 'matching') {
       const selects = document.querySelectorAll(`select[data-question-id=&quot;${q.id}&quot;]`);
       const answers = Array.from(selects).map(s =&gt; s.value);
       if(answers.every(a =&gt; a !== '')) {
           appState.userAnswers[q.id] = answers.map(a =&gt; parseInt(a));
       } else {
           delete appState.userAnswers[q.id];
       }
   }

   if (appState.currentQuizData.config.instantFeedback) {
       checkAnswerInstantly(q, input);
   }
   updateProgress();
   saveQuizProgress();
   
   const allAnswered = Object.keys(appState.userAnswers).length === appState.shuffledQuestions.length;
   const { config } = appState.currentQuizData;

   if (config.singleQuestionMode &amp;&amp; config.autoNextQuestion &amp;&amp; allAnswered) {
       setTimeout(() =&gt; {
           if (document.getElementById('quiz').classList.contains('active')) {
                submitQuiz();
           }
       }, 800);
   } else if (['multiple-choice', 'true-false'].includes(q.type)) {
       handleAutoNext();
   }
}

function handleAutoNext() { const { config } = appState.currentQuizData; if (!config.autoNextQuestion || !config.singleQuestionMode) return; if (appState.currentQuestionIndex &lt; appState.shuffledQuestions.length - 1) { setTimeout(() =&gt; { nextQuestion(); }, 400); } else { const submitBtn = document.getElementById('submitBtn'); if (submitBtn) { submitBtn.style.boxShadow = '0 0 25px var(--secondary-glow)'; setTimeout(() =&gt; { if (submitBtn) submitBtn.style.boxShadow = ''; }, 1200); } } }

function checkAnswerInstantly(question, inputElement) {
   const card = document.getElementById(`card_${question.id}`);
   if (!card || card.classList.contains('answered')) return;
   let isCorrect = false;
   const userAnswer = appState.userAnswers[question.id];
   if (question.type === 'multiple-choice' || question.type === 'true-false') { isCorrect = userAnswer === question.correctAnswer; } else if (question.type === 'fill-in-the-blank') { const trimmedUserAnswer = (userAnswer || '').trim().toLowerCase(); if (Array.isArray(question.correctAnswer)) { isCorrect = question.correctAnswer.some(ans =&gt; ans.toLowerCase() === trimmedUserAnswer); } else { isCorrect = trimmedUserAnswer === String(question.correctAnswer).toLowerCase(); } } else if (question.type === 'multiple-selection' || question.type === 'matching') { return; }
   if (isCorrect) { appState.currentStreak++; if (appState.currentStreak &gt; appState.longestStreak) { appState.longestStreak = appState.currentStreak; } if (appState.currentStreak &gt;= 3) { showStreakNotification(appState.currentStreak); } if (appState.currentStreak === 10) { unlockAchievement('STREAK_MASTER'); } } else { appState.currentStreak = 0; }
   card.classList.add('answered'); const explanationEl = card.querySelector('.instant-explanation'); if (question.type === 'multiple-choice' || question.type === 'true-false') { const correctValue = question.type === 'true-false' ? String(question.correctAnswer) : appState.shuffledOptions[question.id].findIndex(opt =&gt; opt.originalIndex === question.correctAnswer); const userValue = inputElement.value; const correctLabel = card.querySelector(`label[for=&quot;${inputElement.id.replace(userValue, correctValue)}&quot;]`); const userLabel = card.querySelector(`label[for=&quot;${inputElement.id}&quot;]`); if (isCorrect) { if(userLabel) userLabel.classList.add('instant-correct'); } else { if(userLabel) userLabel.classList.add('instant-incorrect'); if(correctLabel) correctLabel.classList.add('instant-correct'); } } else if (question.type === 'fill-in-the-blank') { inputElement.classList.add(isCorrect ? 'instant-correct' : 'instant-incorrect'); inputElement.style.borderColor = isCorrect ? 'var(--success-glow)' : 'var(--danger-glow)'; } if (explanationEl &amp;&amp; question.explanation) { explanationEl.style.display = 'block'; }
}

function updateProgress() { const total = appState.shuffledQuestions.length; const answered = Object.keys(appState.userAnswers).length; const progressBar = document.getElementById('progressBarInner'); if (progressBar) { progressBar.style.width = `${(answered / total) * 100}%`; } }

// --- TIMER &amp; PAUSE LOGIC ---
function startTimer(seconds) { if (appState.quizTimer) clearInterval(appState.quizTimer); appState.timeLeft = seconds; const timerEl = document.getElementById('timer'); if (timerEl) timerEl.textContent = formatTime(appState.timeLeft); appState.quizTimer = setInterval(() =&gt; { if (appState.isPaused) return; appState.timeLeft--; if (timerEl) timerEl.textContent = formatTime(appState.timeLeft); if (appState.timeLeft &lt;= 0) { clearInterval(appState.quizTimer); submitQuiz(); } }, 1000); }
function pauseQuiz() { appState.isPaused = true; document.getElementById('pause-overlay').style.display = 'flex'; }
function resumeQuiz() { appState.isPaused = false; document.getElementById('pause-overlay').style.display = 'none'; }
function confirmSubmitQuiz() { const unanswered = appState.shuffledQuestions.length - Object.keys(appState.userAnswers).length; const message = unanswered &gt; 0 ? `B·∫°n c√≤n ${unanswered} c√¢u ch∆∞a tr·∫£ l·ªùi. B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i?` : 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?'; showModal('modal', 'X√°c nh·∫≠n n·ªôp b√†i', message, submitQuiz); }

function submitQuiz() {
   if (appState.quizTimer) clearInterval(appState.quizTimer);
   const quizContent = document.getElementById('quizContent');
   quizContent.innerHTML = `&lt;div style=&quot;display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center;&quot;&gt;&lt;div class=&quot;loader&quot;&gt;&lt;/div&gt;&lt;p style=&quot;margin-top: 20px; font-size: 1.2em;&quot;&gt;ƒêang ch·∫•m b√†i, vui l√≤ng ch·ªù...&lt;/p&gt;&lt;/div&gt;`;

   setTimeout(() =&gt; {
       appState.quizEndTime = new Date();
       let userScore = 0, totalScore = 0, correctCount = 0;
       const originalQuestions = appState.currentQuizData.questions;

       originalQuestions.forEach(q =&gt; {
           const userAnswer = appState.userAnswers[q.id];
           totalScore += (q.points || 10);
           let isCorrect = false;
           if (userAnswer !== undefined) {
               if (q.type === 'multiple-choice' || q.type === 'true-false') isCorrect = userAnswer === q.correctAnswer;
               else if (q.type === 'multiple-selection') isCorrect = arraysEqual(userAnswer, q.correctAnswer);
               else if (q.type === 'fill-in-the-blank') { const trimmedUserAnswer = (userAnswer || '').trim().toLowerCase(); if (Array.isArray(q.correctAnswer)) { isCorrect = q.correctAnswer.some(ans =&gt; ans.toLowerCase() === trimmedUserAnswer); } else { isCorrect = trimmedUserAnswer === String(q.correctAnswer).toLowerCase(); } }
               else if (q.type === 'matching') { isCorrect = userAnswer.every((ans, index) =&gt; ans === index); }
           }
           if (isCorrect) { userScore += (q.points || 10); correctCount++; }
           if (!appState.currentQuizData.config.instantFeedback) { if (isCorrect) { appState.currentStreak++; if (appState.currentStreak &gt; appState.longestStreak) { appState.longestStreak = appState.currentStreak; } } else { appState.currentStreak = 0; } }
       });

       let xpGained = 0; const XP_PER_CORRECT_ANSWER = 50; xpGained += correctCount * XP_PER_CORRECT_ANSWER; xpGained += 100; const accuracyPercentage = totalScore &gt; 0 ? (userScore / totalScore) * 100 : 0; if (accuracyPercentage &gt;= 80) xpGained += 200; if (accuracyPercentage === 100) xpGained += 500; updateXP(xpGained);
       const resultData = { userScore, totalScore, correctCount, xpGained, quizData: appState.currentQuizData, userAnswers: appState.userAnswers, shuffledOptions: appState.shuffledOptions, startTime: appState.quizStartTime, endTime: appState.quizEndTime, timestamp: Date.now() };
       saveHistory(resultData);
       clearQuizProgress();
       renderResultsAndReview(resultData);
       unlockAchievement('FIRST_FLIGHT');
       if (appState.quizHistory.length &gt;= 5) { unlockAchievement('CONSISTENT'); }
       if (accuracyPercentage === 100) { unlockAchievement('PERFECTIONIST'); }
       const timeTaken = (new Date(appState.quizEndTime) - new Date(appState.quizStartTime)) / 1000;
       if (appState.currentQuizData.config.timeLimit &gt; 0 &amp;&amp; timeTaken &lt; appState.currentQuizData.config.timeLimit / 2) { unlockAchievement('LIGHT_SPEED'); }
       if (appState.longestStreak &gt;= 10) { unlockAchievement('STREAK_MASTER'); }
   }, 100);
}

// --- RESULTS &amp; REVIEW ---
function renderResultsAndReview(resultData) {
   const { userScore, totalScore, correctCount, xpGained, quizData, userAnswers } = resultData;
   const percentage = totalScore &gt; 0 ? Math.round((userScore / totalScore) * 100) : 0;
   let status = { class: 'success', icon: 'üèÜ', text: 'Xu·∫•t s·∫Øc!' };
   if (percentage &lt; 50) status = { class: 'error', icon: 'üßë‚ÄçüöÄ', text: 'C·∫ßn c·ªë g·∫Øng th√™m!' };
   else if (percentage &lt; 80) status = { class: 'warning', icon: 'üëç', text: 'L√†m t·ªët l·∫Øm!' };
   else launchConfetti();
   const timeTakenInSeconds = Math.round((new Date(resultData.endTime) - new Date(resultData.startTime)) / 1000);

   const reviewHtml = quizData.questions.map((q, index) =&gt; {
       const userAnswer = userAnswers[q.id];
       let isCorrect = false;
       let reviewOptionsHtml = '';

       if (userAnswer !== undefined) {
           if (q.type === 'multiple-choice' || q.type === 'true-false') isCorrect = userAnswer === q.correctAnswer;
           else if (q.type === 'multiple-selection') isCorrect = arraysEqual(userAnswer, q.correctAnswer);
           else if (q.type === 'fill-in-the-blank') { const trimmedUserAnswer = (userAnswer || '').trim().toLowerCase(); if (Array.isArray(q.correctAnswer)) { isCorrect = q.correctAnswer.some(ans =&gt; ans.toLowerCase() === trimmedUserAnswer); } else { isCorrect = trimmedUserAnswer === String(q.correctAnswer).toLowerCase(); } }
           else if (q.type === 'matching') isCorrect = userAnswer.every((ans, i) =&gt; ans === i);
       }

       if (q.type === 'multiple-choice' || q.type === 'multiple-selection') {
           reviewOptionsHtml = q.options.map((opt, i) =&gt; { const isCorrectAnswer = Array.isArray(q.correctAnswer) ? q.correctAnswer.includes(i) : q.correctAnswer === i; const isUserAnswer = Array.isArray(userAnswer) ? userAnswer.includes(i) : userAnswer === i; let className = 'review-option'; if (isCorrectAnswer) className += ' correct-answer'; if (isUserAnswer &amp;&amp; !isCorrectAnswer) className += ' user-answer incorrect'; else if (isUserAnswer) className += ' user-answer'; return `&lt;li class=&quot;${className}&quot;&gt;${opt}&lt;/li&gt;`; }).join('');
       } else if (q.type === 'true-false') {
           reviewOptionsHtml = `&lt;li class=&quot;review-option ${q.correctAnswer ? 'correct-answer' : ''} ${userAnswer === true ? 'user-answer' : ''} ${userAnswer === true &amp;&amp; !q.correctAnswer ? 'incorrect' : ''}&quot;&gt;ƒê√∫ng&lt;/li&gt;&lt;li class=&quot;review-option ${!q.correctAnswer ? 'correct-answer' : ''} ${userAnswer === false ? 'user-answer' : ''} ${userAnswer === false &amp;&amp; q.correctAnswer ? 'incorrect' : ''}&quot;&gt;Sai&lt;/li&gt;`;
       } else if (q.type === 'fill-in-the-blank') {
           const correctAnswerText = Array.isArray(q.correctAnswer) ? q.correctAnswer.join(' ho·∫∑c ') : q.correctAnswer;
           reviewOptionsHtml = `&lt;li class=&quot;review-option user-answer ${!isCorrect ? 'incorrect' : ''}&quot;&gt;C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n: &lt;strong&gt;${userAnswer || '&lt;em&gt;(ch∆∞a tr·∫£ l·ªùi)&lt;/em&gt;'}&lt;/strong&gt;&lt;/li&gt;&lt;li class=&quot;review-option correct-answer&quot;&gt;ƒê√°p √°n ƒë√∫ng: &lt;strong&gt;${correctAnswerText}&lt;/strong&gt;&lt;/li&gt;`;
       } else if (q.type === 'matching') {
           reviewOptionsHtml = q.prompts.map((prompt, i) =&gt; { const userAnsIndex = userAnswer ? userAnswer[i] : -1; const userAnsText = userAnsIndex &gt; -1 ? q.answers[userAnsIndex] : '&lt;em&gt;(ch∆∞a tr·∫£ l·ªùi)&lt;/em&gt;'; const correctAnsText = q.answers[i]; const isPairCorrect = userAnsIndex === i; return `&lt;li class=&quot;review-option ${isPairCorrect ? 'correct-answer' : 'user-answer incorrect'}&quot;&gt;${prompt} &lt;i class=&quot;fa-solid fa-arrow-right&quot;&gt;&lt;/i&gt; ${userAnsText} ${!isPairCorrect ? `(ƒê√∫ng: ${correctAnsText})` : ''}&lt;/li&gt;`; }).join('');
       }

       return `&lt;div class=&quot;review-question ${isCorrect ? 'correct' : 'incorrect'}&quot;&gt;&lt;p&gt;&lt;strong&gt;C√¢u ${index + 1}:&lt;/strong&gt; ${q.question}&lt;/p&gt;${q.imageUrl ? `&lt;img src=&quot;${q.imageUrl}&quot; alt=&quot;H√¨nh ·∫£nh c√¢u h·ªèi&quot; class=&quot;question-image&quot; loading=&quot;lazy&quot; onerror=&quot;this.style.display='none'&quot;&gt;` : ''}&lt;ul&gt;${reviewOptionsHtml}&lt;/ul&gt;${q.explanation ? `&lt;div class=&quot;explanation-box&quot;&gt;${q.explanation}&lt;/div&gt;` : ''}&lt;/div&gt;`;
   }).join('');

   const quizContent = document.getElementById('quizContent');
   quizContent.innerHTML = `&lt;style&gt;.results{text-align:center}.score{font-size:2.5em;font-weight:700;margin:10px 0;background:linear-gradient(45deg,var(--primary-glow),var(--secondary-glow));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;max-width:500px;margin:20px auto;text-align:center}.stat-item{background:rgba(0,0,0,.2);padding:15px;border-radius:8px}.stat-item h4{margin-bottom:5px;color:var(--primary-glow)}.review-section{margin-top:30px;text-align:left}.review-question{background:rgba(0,0,0,.2);padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid}.review-question.correct{border-left-color:var(--success-glow)}.review-question.incorrect{border-left-color:var(--danger-glow)}.review-question ul{list-style-type:none;padding-left:0;margin-top:10px}.review-option{padding:8px;border-radius:4px;margin-bottom:5px}.review-option.correct-answer{background:rgba(0,255,170,.2);color:var(--success-glow);font-weight:700}.review-option.user-answer.incorrect{background:rgba(255,77,77,.2);text-decoration:line-through}.explanation-box{background:rgba(255,238,0,.1);border:1px solid var(--warning-glow);color:var(--warning-glow);padding:10px;border-radius:5px;margin-top:10px}&lt;/style&gt;&lt;div id=&quot;questions-list-container&quot; style=&quot;overflow-y:auto;flex-grow:1;padding:20px&quot;&gt;&lt;div class=&quot;results&quot;&gt;&lt;h2&gt;${status.icon} K·∫øt Qu·∫£&lt;/h2&gt;&lt;div class=&quot;score&quot; id=&quot;finalScore&quot;&gt;0 / ${totalScore} ƒëi·ªÉm&lt;/div&gt;&lt;div class=&quot;status-message ${status.class}&quot;&gt;${status.text} (${percentage}%)&lt;/div&gt;&lt;div class=&quot;stats-grid&quot;&gt;&lt;div class=&quot;stat-item&quot;&gt;&lt;h4&gt;&lt;i class=&quot;fa-solid fa-check&quot;&gt;&lt;/i&gt; ƒê√∫ng&lt;/h4&gt;&lt;p&gt;${correctCount} / ${quizData.questions.length}&lt;/p&gt;&lt;/div&gt;&lt;div class=&quot;stat-item&quot;&gt;&lt;h4&gt;&lt;i class=&quot;fa-solid fa-clock&quot;&gt;&lt;/i&gt; Th·ªùi gian&lt;/h4&gt;&lt;p&gt;${formatTime(timeTakenInSeconds)}&lt;/p&gt;&lt;/div&gt;&lt;div class=&quot;stat-item&quot; style=&quot;grid-column:1/-1;background:rgba(0,255,170,.1)&quot;&gt;&lt;h4&gt;&lt;i class=&quot;fa-solid fa-star&quot;&gt;&lt;/i&gt; XP Nh·∫≠n ƒê∆∞·ª£c&lt;/h4&gt;&lt;p style=&quot;font-size:1.2em;color:var(--success-glow);font-weight:700&quot;&gt;+${xpGained} XP&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;button-group&quot;&gt;&lt;button class=&quot;button&quot; onclick=&quot;resetQuiz()&quot;&gt;&lt;i class=&quot;fa-solid fa-rotate-right&quot;&gt;&lt;/i&gt; Th·ª≠ L·∫°i&lt;/button&gt;&lt;button class=&quot;button secondary&quot; onclick=&quot;showTab('creator')&quot;&gt;&lt;i class=&quot;fa-solid fa-house&quot;&gt;&lt;/i&gt; V·ªÅ Trang Ch·ªß&lt;/button&gt;&lt;/div&gt;&lt;div class=&quot;review-section&quot;&gt;&lt;h3&gt;&lt;i class=&quot;fa-solid fa-magnifying-glass&quot;&gt;&lt;/i&gt; Xem L·∫°i B√†i L√†m&lt;/h3&gt;&lt;div class=&quot;review-filters button-group&quot;&gt;&lt;button class=&quot;button active&quot; onclick=&quot;filterReview('all',this)&quot;&gt;T·∫•t c·∫£&lt;/button&gt;&lt;button class=&quot;button&quot; onclick=&quot;filterReview('correct',this)&quot;&gt;Ch·ªâ c√¢u ƒë√∫ng&lt;/button&gt;&lt;button class=&quot;button&quot; onclick=&quot;filterReview('incorrect',this)&quot;&gt;Ch·ªâ c√¢u sai&lt;/button&gt;&lt;/div&gt;&lt;div id=&quot;review-list&quot;&gt;${reviewHtml}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;`;
   animateScore(document.getElementById('finalScore'), userScore, totalScore);
   document.getElementById('quiz').scrollTop = 0;
}
function filterReview(filter, btnElement) { document.querySelectorAll('.review-filters .button').forEach(btn =&gt; btn.classList.remove('active')); btnElement.classList.add('active'); const questions = document.querySelectorAll('#review-list .review-question'); questions.forEach(q =&gt; { q.classList.remove('hidden'); if (filter === 'all') return; if (!q.classList.contains(filter)) { q.classList.add('hidden'); } }); }
function resetQuiz() { if (appState.currentQuizData) { appState.userAnswers = {}; initializeQuiz(); } }

// --- HISTORY MANAGEMENT ---
function loadHistory() { const historyJson = localStorage.getItem('quizHistory'); if (historyJson) { appState.quizHistory = JSON.parse(historyJson); } }
function saveHistory(resultData) { appState.quizHistory.unshift(resultData); if (appState.quizHistory.length &gt; 20) { appState.quizHistory.pop(); } localStorage.setItem('quizHistory', JSON.stringify(appState.quizHistory)); }
function clearHistory() { appState.quizHistory = []; localStorage.removeItem('quizHistory'); renderHistory(); }
function renderHistory(searchTerm = '') { const historyListEl = document.getElementById('historyList'); const lowerCaseSearchTerm = searchTerm.toLowerCase(); const filteredHistory = appState.quizHistory.filter(item =&gt; item.quizData.title.toLowerCase().includes(lowerCaseSearchTerm) ); if (filteredHistory.length === 0) { historyListEl.innerHTML = `&lt;p style=&quot;text-align: center; opacity: 0.7;&quot;&gt;Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o.&lt;/p&gt;`; return; } historyListEl.innerHTML = filteredHistory.map((item, index) =&gt; { const originalIndex = appState.quizHistory.indexOf(item); const date = new Date(item.timestamp); const percentage = item.totalScore &gt; 0 ? Math.round((item.userScore / item.totalScore) * 100) : 0; return ` &lt;div class=&quot;history-item&quot;&gt; &lt;div class=&quot;history-info&quot;&gt; &lt;h4&gt;${item.quizData.title}&lt;/h4&gt; &lt;p&gt;${date.toLocaleString('vi-VN')}&lt;/p&gt; &lt;/div&gt; &lt;div class=&quot;history-score&quot;&gt;${item.userScore}/${item.totalScore} (${percentage}%)&lt;/div&gt; &lt;button class=&quot;button&quot; onclick=&quot;viewHistoryItem(${originalIndex})&quot;&gt;&lt;i class=&quot;fa-solid fa-eye&quot;&gt;&lt;/i&gt; Xem l·∫°i&lt;/button&gt; &lt;/div&gt; `; }).join(''); }
function viewHistoryItem(index) { const historyItem = appState.quizHistory[index]; if (historyItem) { renderResultsAndReview(historyItem); showTab('quiz'); } }

// --- QUIZ LIBRARY MANAGEMENT ---
function loadSavedQuizzes() { const quizzesJson = localStorage.getItem('savedQuizzes'); if (quizzesJson) { appState.savedQuizzes = JSON.parse(quizzesJson); } }
function saveQuizToLibrary() { if (!appState.creatorData.title.trim()) { showModal('modal', 'L·ªói', 'Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ cho ƒë·ªÅ thi tr∆∞·ªõc khi l∆∞u.', () =&gt; {}); return; } if (appState.creatorData.questions.length === 0) { showModal('modal', 'L·ªói', 'Kh√¥ng th·ªÉ l∆∞u m·ªôt ƒë·ªÅ thi r·ªóng.', () =&gt; {}); return; } const existingIndex = appState.savedQuizzes.findIndex(q =&gt; q.id === appState.creatorData.id); if (existingIndex &gt; -1) { appState.savedQuizzes[existingIndex] = JSON.parse(JSON.stringify(appState.creatorData)); } else { appState.savedQuizzes.unshift(JSON.parse(JSON.stringify(appState.creatorData))); } localStorage.setItem('savedQuizzes', JSON.stringify(appState.savedQuizzes)); appState.hasUnsavedChanges = false; showStatus('creatorStatus', '‚úÖ ƒê√£ l∆∞u ƒë·ªÅ thi v√†o th∆∞ vi·ªán!', 'success'); unlockAchievement('CREATOR'); if (appState.savedQuizzes.length &gt;= 5) { unlockAchievement('LIBRARIAN'); } }
function showQuizLibrary() { const listEl = document.getElementById('quiz-library-list'); if (appState.savedQuizzes.length === 0) { listEl.innerHTML = `&lt;p style=&quot;text-align: center; opacity: 0.7;&quot;&gt;Th∆∞ vi·ªán c·ªßa b·∫°n tr·ªëng.&lt;/p&gt;`; } else { listEl.innerHTML = appState.savedQuizzes.map((quiz, index) =&gt; ` &lt;div class=&quot;quiz-library-item&quot;&gt; &lt;span&gt;${quiz.title} (${quiz.questions.length} c√¢u)&lt;/span&gt; &lt;div class=&quot;button-group&quot; style=&quot;margin-top: 0;&quot;&gt; &lt;button class=&quot;button&quot; title=&quot;T·∫£i&quot; onclick=&quot;loadQuizFromLibrary(${index})&quot;&gt;&lt;i class=&quot;fa-solid fa-download&quot;&gt;&lt;/i&gt;&lt;/button&gt; &lt;button class=&quot;button danger&quot; title=&quot;X√≥a&quot; onclick=&quot;deleteQuizFromLibrary(${index})&quot;&gt;&lt;i class=&quot;fa-solid fa-trash&quot;&gt;&lt;/i&gt;&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; `).join(''); } showModal('quizLibraryModal'); }
function loadQuizFromLibrary(index) { const quizToLoad = appState.savedQuizzes[index]; if (quizToLoad) { appState.creatorData = JSON.parse(JSON.stringify(quizToLoad)); renderCreatorUI(); hideModal('quizLibraryModal'); showStatus('creatorStatus', `‚úÖ ƒê√£ t·∫£i ƒë·ªÅ thi &quot;${quizToLoad.title}&quot;!`, 'success'); } }
function deleteQuizFromLibrary(index) { const quizToDelete = appState.savedQuizzes[index]; showModal('modal', 'X√°c nh·∫≠n x√≥a', `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë·ªÅ thi &quot;${quizToDelete.title}&quot; kh·ªèi th∆∞ vi·ªán?`, () =&gt; { appState.savedQuizzes.splice(index, 1); localStorage.setItem('savedQuizzes', JSON.stringify(appState.savedQuizzes)); showQuizLibrary(); }); }

// --- AUTO-SAVE PROGRESS ---
function saveQuizProgress() { if (!appState.currentQuizData) return; const progress = { quizTitle: appState.currentQuizData.title, userAnswers: appState.userAnswers, timeLeft: appState.timeLeft, currentQuestionIndex: appState.currentQuestionIndex, shuffledQuestions: appState.shuffledQuestions, shuffledOptions: appState.shuffledOptions, startTime: appState.quizStartTime }; sessionStorage.setItem('quizProgress', JSON.stringify(progress)); }
function loadQuizProgress() { const savedProgress = JSON.parse(sessionStorage.getItem('quizProgress')); if (!savedProgress || !appState.currentQuizData || savedProgress.quizTitle !== appState.currentQuizData.title) { startNewQuiz(); return; } appState.userAnswers = savedProgress.userAnswers; appState.timeLeft = savedProgress.timeLeft; appState.currentQuestionIndex = savedProgress.currentQuestionIndex; appState.shuffledQuestions = savedProgress.shuffledQuestions; appState.shuffledOptions = savedProgress.shuffledOptions; appState.quizStartTime = savedProgress.startTime; appState.isPaused = false; renderQuizUI(); if (appState.currentQuizData.config.timeLimit &gt; 0) { startTimer(appState.timeLeft); } }
function clearQuizProgress() { sessionStorage.removeItem('quizProgress'); }
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
</body>
</html>